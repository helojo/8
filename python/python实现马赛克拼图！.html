<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修python实现马赛克拼图！' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>python实现马赛克拼图！</center></div><div class='banquan'>原文出处:本文由博客园博主布拉莫维奇提供。<br/>
原文连接:https://www.cnblogs.com/blamwq/p/11706844.html</div><br>
    <h1 id="hpython">python实现马赛克拼图</h1>
<h3 id="h"><strong>直接上代码!</strong></h3>
<h2 id="h-1">代码如下：</h2>
<pre><code><code><span class="hljs-comment">#!/usr/local/bin/python3<br /><span class="hljs-comment">#&nbsp;&nbsp;--*--&nbsp;coding:utf8&nbsp;--*--<br /><br /><span class="hljs-keyword">import&nbsp;getopt<br /><span class="hljs-keyword">import&nbsp;sys<br /><span class="hljs-keyword">import&nbsp;os<br /><br /><span class="hljs-keyword">import&nbsp;logging<br /><span class="hljs-keyword">from&nbsp;PIL&nbsp;<span class="hljs-keyword">import&nbsp;Image<br /><span class="hljs-keyword">from&nbsp;multiprocessing&nbsp;<span class="hljs-keyword">import&nbsp;Process,&nbsp;Queue,&nbsp;cpu_count<br /><br />TILE_SIZE&nbsp;=&nbsp;<span class="hljs-number">30&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;素材图片大小<br />TILE_MATCH_RES&nbsp;=&nbsp;<span class="hljs-number">10&nbsp;&nbsp;<span class="hljs-comment">#配置指数&nbsp;&nbsp;，值越大匹配度越高，执行时间越长<br />ENLARGEMENT&nbsp;=&nbsp;<span class="hljs-number">4&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;生成的图片是原始图片的多少倍<br /><br />TILE_BLOCK_SIZE&nbsp;=&nbsp;int(TILE_SIZE&nbsp;/&nbsp;max(min(TILE_MATCH_RES,&nbsp;TILE_SIZE),&nbsp;<span class="hljs-number">1))<br />WORKER_COUNT&nbsp;=&nbsp;max(cpu_count()&nbsp;-&nbsp;<span class="hljs-number">1,&nbsp;<span class="hljs-number">1)<br />EOQ_VALUE&nbsp;=&nbsp;<span class="hljs-keyword">None<br />WARN_INFO&nbsp;=&nbsp;<span class="hljs-string">"""&nbsp;*缺少有效参数*<br />&nbsp;&nbsp;&nbsp;&nbsp;参数:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-i&nbsp;[--image]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;原图片地址<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-t&nbsp;[--tiles_dir]&nbsp;:&nbsp;素材目录地址<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-o&nbsp;[--outfile]&nbsp;&nbsp;&nbsp;:&nbsp;输出文件地址&nbsp;【可选】<br />"""<br /><br /><br /><span class="hljs-class"><span class="hljs-keyword">class&nbsp;<span class="hljs-title">TileProcessor:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__init__<span class="hljs-params">(self,&nbsp;tiles_directory):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tiles_directory&nbsp;=&nbsp;tiles_directory<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__process_tile<span class="hljs-params">(self,&nbsp;tile_path):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img&nbsp;=&nbsp;Image.open(tile_path)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;tiles&nbsp;must&nbsp;be&nbsp;square,&nbsp;so&nbsp;get&nbsp;the&nbsp;largest&nbsp;square&nbsp;that&nbsp;fits&nbsp;inside&nbsp;the&nbsp;image<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;=&nbsp;img.size[<span class="hljs-number">0]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;=&nbsp;img.size[<span class="hljs-number">1]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_dimension&nbsp;=&nbsp;min(w,&nbsp;h)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_crop&nbsp;=&nbsp;(w&nbsp;-&nbsp;min_dimension)&nbsp;/&nbsp;<span class="hljs-number">2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_crop&nbsp;=&nbsp;(h&nbsp;-&nbsp;min_dimension)&nbsp;/&nbsp;<span class="hljs-number">2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img&nbsp;=&nbsp;img.crop((w_crop,&nbsp;h_crop,&nbsp;w&nbsp;-&nbsp;w_crop,&nbsp;h&nbsp;-&nbsp;h_crop))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_tile_img&nbsp;=&nbsp;img.resize((TILE_SIZE,&nbsp;TILE_SIZE),&nbsp;Image.ANTIALIAS)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small_tile_img&nbsp;=&nbsp;img.resize((int(TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE),&nbsp;int(TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE)),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image.ANTIALIAS)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;(large_tile_img.convert(<span class="hljs-string">'RGB'),&nbsp;small_tile_img.convert(<span class="hljs-string">'RGB'))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except&nbsp;Exception&nbsp;<span class="hljs-keyword">as&nbsp;e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.warning(e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;(<span class="hljs-keyword">None,&nbsp;<span class="hljs-keyword">None)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">get_tiles<span class="hljs-params">(self):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_tiles&nbsp;=&nbsp;[]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small_tiles&nbsp;=&nbsp;[]<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'从&nbsp;\'%s\'&nbsp;获取图片素材...'&nbsp;%&nbsp;self.tiles_directory)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;search&nbsp;the&nbsp;tiles&nbsp;directory&nbsp;recursively<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;root,&nbsp;subFolders,&nbsp;files&nbsp;<span class="hljs-keyword">in&nbsp;os.walk(self.tiles_directory):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;tile_name&nbsp;<span class="hljs-keyword">in&nbsp;files:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tile_path&nbsp;=&nbsp;os.path.join(root,&nbsp;tile_name)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_tile,&nbsp;small_tile&nbsp;=&nbsp;self.__process_tile(tile_path)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.debug(large_tile)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.debug(small_tile)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;large_tile:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_tiles.append(large_tile)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small_tiles.append(small_tile)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'读取素材&nbsp;%s&nbsp;完成.'&nbsp;%&nbsp;len(large_tiles))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;(large_tiles,&nbsp;small_tiles)<br /><br /><br /><span class="hljs-class"><span class="hljs-keyword">class&nbsp;<span class="hljs-title">TargetImage:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__init__<span class="hljs-params">(self,&nbsp;image_path):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.image_path&nbsp;=&nbsp;image_path<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">get_data<span class="hljs-params">(self):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'处理主图片...')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img&nbsp;=&nbsp;Image.open(self.image_path)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;=&nbsp;img.size[<span class="hljs-number">0]&nbsp;*&nbsp;ENLARGEMENT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;=&nbsp;img.size[<span class="hljs-number">1]&nbsp;*&nbsp;ENLARGEMENT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_img&nbsp;=&nbsp;img.resize((w,&nbsp;h),&nbsp;Image.ANTIALIAS)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_diff&nbsp;=&nbsp;(w&nbsp;%&nbsp;TILE_SIZE)&nbsp;/&nbsp;<span class="hljs-number">2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_diff&nbsp;=&nbsp;(h&nbsp;%&nbsp;TILE_SIZE)&nbsp;/&nbsp;<span class="hljs-number">2<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;if&nbsp;necesary,&nbsp;crop&nbsp;the&nbsp;image&nbsp;slightly&nbsp;so&nbsp;we&nbsp;use&nbsp;a&nbsp;whole&nbsp;number&nbsp;of&nbsp;tiles&nbsp;horizontally&nbsp;and&nbsp;vertically<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;w_diff&nbsp;<span class="hljs-keyword">or&nbsp;h_diff:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_img&nbsp;=&nbsp;large_img.crop((w_diff,&nbsp;h_diff,&nbsp;w&nbsp;-&nbsp;w_diff,&nbsp;h&nbsp;-&nbsp;h_diff))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small_img&nbsp;=&nbsp;large_img.resize((int(w&nbsp;/&nbsp;TILE_BLOCK_SIZE),&nbsp;int(h&nbsp;/&nbsp;TILE_BLOCK_SIZE)),&nbsp;Image.ANTIALIAS)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;image_data&nbsp;=&nbsp;(large_img.convert(<span class="hljs-string">'RGB'),&nbsp;small_img.convert(<span class="hljs-string">'RGB'))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'主图片处理完成.')<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;image_data<br /><br /><br /><span class="hljs-class"><span class="hljs-keyword">class&nbsp;<span class="hljs-title">TileFitter:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__init__<span class="hljs-params">(self,&nbsp;tiles_data):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tiles_data&nbsp;=&nbsp;tiles_data<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__get_tile_diff<span class="hljs-params">(self,&nbsp;t1,&nbsp;t2,&nbsp;bail_out_value):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff&nbsp;=&nbsp;<span class="hljs-number">0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;i&nbsp;<span class="hljs-keyword">in&nbsp;range(len(t1)):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;diff&nbsp;+=&nbsp;(abs(t1[i][0]&nbsp;-&nbsp;t2[i][0])&nbsp;+&nbsp;abs(t1[i][1]&nbsp;-&nbsp;t2[i][1])&nbsp;+&nbsp;abs(t1[i][2]&nbsp;-&nbsp;t2[i][2]))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff&nbsp;+=&nbsp;((t1[i][<span class="hljs-number">0]&nbsp;-&nbsp;t2[i][<span class="hljs-number">0])&nbsp;**&nbsp;<span class="hljs-number">2&nbsp;+&nbsp;(t1[i][<span class="hljs-number">1]&nbsp;-&nbsp;t2[i][<span class="hljs-number">1])&nbsp;**&nbsp;<span class="hljs-number">2&nbsp;+&nbsp;(t1[i][<span class="hljs-number">2]&nbsp;-&nbsp;t2[i][<span class="hljs-number">2])&nbsp;**&nbsp;<span class="hljs-number">2)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;diff&nbsp;&gt;&nbsp;bail_out_value:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;we&nbsp;know&nbsp;already&nbsp;that&nbsp;this&nbsp;isnt&nbsp;going&nbsp;to&nbsp;be&nbsp;the&nbsp;best&nbsp;fit,&nbsp;so&nbsp;no&nbsp;point&nbsp;continuing&nbsp;with&nbsp;this&nbsp;tile<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;diff<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;diff<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">get_best_fit_tile<span class="hljs-params">(self,&nbsp;img_data):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_fit_tile_index&nbsp;=&nbsp;<span class="hljs-keyword">None<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_diff&nbsp;=&nbsp;sys.maxsize<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tile_index&nbsp;=&nbsp;<span class="hljs-number">0<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;go&nbsp;through&nbsp;each&nbsp;tile&nbsp;in&nbsp;turn&nbsp;looking&nbsp;for&nbsp;the&nbsp;best&nbsp;match&nbsp;for&nbsp;the&nbsp;part&nbsp;of&nbsp;the&nbsp;image&nbsp;represented&nbsp;by&nbsp;'img_data'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;tile_data&nbsp;<span class="hljs-keyword">in&nbsp;self.tiles_data:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff&nbsp;=&nbsp;self.__get_tile_diff(img_data,&nbsp;tile_data,&nbsp;min_diff)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;logging.info(diff)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;diff&nbsp;&lt;&nbsp;min_diff:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_diff&nbsp;=&nbsp;diff<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_fit_tile_index&nbsp;=&nbsp;tile_index<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tile_index&nbsp;+=&nbsp;<span class="hljs-number">1<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return&nbsp;best_fit_tile_index<br /><br /><br /><span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">fit_tiles<span class="hljs-params">(work_queue,&nbsp;result_queue,&nbsp;tiles_data):<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;this&nbsp;function&nbsp;gets&nbsp;run&nbsp;by&nbsp;the&nbsp;worker&nbsp;processes,&nbsp;one&nbsp;on&nbsp;each&nbsp;CPU&nbsp;core<br />&nbsp;&nbsp;&nbsp;&nbsp;tile_fitter&nbsp;=&nbsp;TileFitter(tiles_data)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while&nbsp;<span class="hljs-keyword">True:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img_data,&nbsp;img_coords&nbsp;=&nbsp;work_queue.get(<span class="hljs-keyword">True)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;img_data&nbsp;==&nbsp;EOQ_VALUE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">break<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tile_index&nbsp;=&nbsp;tile_fitter.get_best_fit_tile(img_data)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_queue.put((img_coords,&nbsp;tile_index))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except&nbsp;KeyboardInterrupt:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">pass<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;let&nbsp;the&nbsp;result&nbsp;handler&nbsp;know&nbsp;that&nbsp;this&nbsp;worker&nbsp;has&nbsp;finished&nbsp;everything<br />&nbsp;&nbsp;&nbsp;&nbsp;result_queue.put((EOQ_VALUE,&nbsp;EOQ_VALUE))<br /><br /><br /><span class="hljs-class"><span class="hljs-keyword">class&nbsp;<span class="hljs-title">ProgressCounter:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__init__<span class="hljs-params">(self,&nbsp;total):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.total&nbsp;=&nbsp;total<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.counter&nbsp;=&nbsp;<span class="hljs-number">0<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">update<span class="hljs-params">(self):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.counter&nbsp;+=&nbsp;<span class="hljs-number">1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.stdout.write(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"进度:&nbsp;%s%%&nbsp;%s"&nbsp;%&nbsp;((<span class="hljs-number">100&nbsp;*&nbsp;self.counter&nbsp;/&nbsp;self.total),&nbsp;<span class="hljs-string">"\r"))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;sys.stdout.write("Progress:&nbsp;%s%%&nbsp;%s"&nbsp;%&nbsp;(100&nbsp;*&nbsp;self.counter&nbsp;/&nbsp;self.total,&nbsp;"\r"))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;sys.stdout.flush()<br /><br /><br /><span class="hljs-class"><span class="hljs-keyword">class&nbsp;<span class="hljs-title">MosaicImage:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">__init__<span class="hljs-params">(self,&nbsp;original_img,&nbsp;outfile):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.image&nbsp;=&nbsp;Image.new(original_img.mode,&nbsp;original_img.size)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.x_tile_count&nbsp;=&nbsp;int(original_img.size[<span class="hljs-number">0]&nbsp;/&nbsp;TILE_SIZE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.y_tile_count&nbsp;=&nbsp;int(original_img.size[<span class="hljs-number">1]&nbsp;/&nbsp;TILE_SIZE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.total_tiles&nbsp;=&nbsp;self.x_tile_count&nbsp;*&nbsp;self.y_tile_count<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.outfile&nbsp;=&nbsp;outfile<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">add_tile<span class="hljs-params">(self,&nbsp;tile_data,&nbsp;coords):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img&nbsp;=&nbsp;Image.new(<span class="hljs-string">'RGB',&nbsp;(TILE_SIZE,&nbsp;TILE_SIZE))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img.putdata(tile_data)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.image.paste(img,&nbsp;coords)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">save<span class="hljs-params">(self,&nbsp;path):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.image.save(path)<br /><br /><br /><span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">build_mosaic<span class="hljs-params">(result_queue,&nbsp;all_tile_data_large,&nbsp;original_img_large,&nbsp;outfile):<br />&nbsp;&nbsp;&nbsp;&nbsp;mosaic&nbsp;=&nbsp;MosaicImage(original_img_large,&nbsp;outfile)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;active_workers&nbsp;=&nbsp;WORKER_COUNT<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while&nbsp;<span class="hljs-keyword">True:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img_coords,&nbsp;best_fit_tile_index&nbsp;=&nbsp;result_queue.get()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;img_coords&nbsp;==&nbsp;EOQ_VALUE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active_workers&nbsp;-=&nbsp;<span class="hljs-number">1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;<span class="hljs-keyword">not&nbsp;active_workers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">break<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tile_data&nbsp;=&nbsp;all_tile_data_large[best_fit_tile_index]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mosaic.add_tile(tile_data,&nbsp;img_coords)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except&nbsp;KeyboardInterrupt:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">pass<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;mosaic.save(mosaic.outfile)<br />&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'============&nbsp;生成成功&nbsp;============')<br /><br /><br /><span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">compose<span class="hljs-params">(original_img,&nbsp;tiles,&nbsp;outfile):<br />&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'生成图片中,按下&nbsp;Ctrl-C&nbsp;中断...')<br />&nbsp;&nbsp;&nbsp;&nbsp;original_img_large,&nbsp;original_img_small&nbsp;=&nbsp;original_img<br />&nbsp;&nbsp;&nbsp;&nbsp;tiles_large,&nbsp;tiles_small&nbsp;=&nbsp;tiles<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;mosaic&nbsp;=&nbsp;MosaicImage(original_img_large,&nbsp;outfile)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;all_tile_data_large&nbsp;=&nbsp;list(map(<span class="hljs-keyword">lambda&nbsp;tile:&nbsp;list(tile.getdata()),&nbsp;tiles_large))<br />&nbsp;&nbsp;&nbsp;&nbsp;all_tile_data_small&nbsp;=&nbsp;list(map(<span class="hljs-keyword">lambda&nbsp;tile:&nbsp;list(tile.getdata()),&nbsp;tiles_small))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;work_queue&nbsp;=&nbsp;Queue(WORKER_COUNT)<br />&nbsp;&nbsp;&nbsp;&nbsp;result_queue&nbsp;=&nbsp;Queue()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;start&nbsp;the&nbsp;worker&nbsp;processes&nbsp;that&nbsp;will&nbsp;build&nbsp;the&nbsp;mosaic&nbsp;image<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process(target=build_mosaic,&nbsp;args=(result_queue,&nbsp;all_tile_data_large,&nbsp;original_img_large,&nbsp;outfile)).start()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;start&nbsp;the&nbsp;worker&nbsp;processes&nbsp;that&nbsp;will&nbsp;perform&nbsp;the&nbsp;tile&nbsp;fitting<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;n&nbsp;<span class="hljs-keyword">in&nbsp;range(WORKER_COUNT):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process(target=fit_tiles,&nbsp;args=(work_queue,&nbsp;result_queue,&nbsp;all_tile_data_small)).start()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;progress&nbsp;=&nbsp;ProgressCounter(mosaic.x_tile_count&nbsp;*&nbsp;mosaic.y_tile_count)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;x&nbsp;<span class="hljs-keyword">in&nbsp;range(mosaic.x_tile_count):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;y&nbsp;<span class="hljs-keyword">in&nbsp;range(mosaic.y_tile_count):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large_box&nbsp;=&nbsp;(x&nbsp;*&nbsp;TILE_SIZE,&nbsp;y&nbsp;*&nbsp;TILE_SIZE,&nbsp;(x&nbsp;+&nbsp;<span class="hljs-number">1)&nbsp;*&nbsp;TILE_SIZE,&nbsp;(y&nbsp;+&nbsp;<span class="hljs-number">1)&nbsp;*&nbsp;TILE_SIZE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small_box&nbsp;=&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;*&nbsp;TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE,&nbsp;y&nbsp;*&nbsp;TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(x&nbsp;+&nbsp;<span class="hljs-number">1)&nbsp;*&nbsp;TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(y&nbsp;+&nbsp;<span class="hljs-number">1)&nbsp;*&nbsp;TILE_SIZE&nbsp;/&nbsp;TILE_BLOCK_SIZE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;work_queue.put((list(original_img_small.crop(small_box).getdata()),&nbsp;large_box))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;progress.update()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except&nbsp;KeyboardInterrupt:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(<span class="hljs-string">'\nHalting,&nbsp;saving&nbsp;partial&nbsp;image&nbsp;please&nbsp;wait...')<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">finally:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;put&nbsp;these&nbsp;special&nbsp;values&nbsp;onto&nbsp;the&nbsp;queue&nbsp;to&nbsp;let&nbsp;the&nbsp;workers&nbsp;know&nbsp;they&nbsp;can&nbsp;terminate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;n&nbsp;<span class="hljs-keyword">in&nbsp;range(WORKER_COUNT):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;work_queue.put((EOQ_VALUE,&nbsp;EOQ_VALUE))<br /><br /><br /><span class="hljs-function"><span class="hljs-keyword">def&nbsp;<span class="hljs-title">mosaic<span class="hljs-params">(img_path,&nbsp;tiles_path,&nbsp;outfile):<br />&nbsp;&nbsp;&nbsp;&nbsp;tiles_data&nbsp;=&nbsp;TileProcessor(tiles_path).get_tiles()<br />&nbsp;&nbsp;&nbsp;&nbsp;image_data&nbsp;=&nbsp;TargetImage(img_path).get_data()<br />&nbsp;&nbsp;&nbsp;&nbsp;compose(image_data,&nbsp;tiles_data,&nbsp;output)<br /><br /><br /><br /><br /><span class="hljs-keyword">if&nbsp;__name__&nbsp;==&nbsp;<span class="hljs-string">'__main__':<br />&nbsp;&nbsp;&nbsp;&nbsp;logging.basicConfig(filename=<span class="hljs-string">'mosaic.log',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;format=<span class="hljs-string">'%(asctime)s&nbsp;&nbsp;%(filename)s&nbsp;:&nbsp;%(levelname)s&nbsp;&nbsp;%(message)s',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;level=logging.INFO)<br />&nbsp;&nbsp;&nbsp;&nbsp;logging.getLogger().addHandler(logging.StreamHandler())<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;opts,&nbsp;args&nbsp;=&nbsp;getopt.gnu_getopt(sys.argv[<span class="hljs-number">1:],&nbsp;<span class="hljs-string">'i:t:o:ts:tr:e:',&nbsp;[<span class="hljs-string">'image=',&nbsp;<span class="hljs-string">'tiles_dir=',&nbsp;<span class="hljs-string">'outfile=',<span class="hljs-string">""])<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;base_image&nbsp;=&nbsp;<span class="hljs-keyword">None<br />&nbsp;&nbsp;&nbsp;&nbsp;tiles_dir&nbsp;=&nbsp;<span class="hljs-keyword">None<br />&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;=&nbsp;<span class="hljs-keyword">None<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;k,&nbsp;v&nbsp;<span class="hljs-keyword">in&nbsp;opts:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;k&nbsp;<span class="hljs-keyword">in&nbsp;(<span class="hljs-string">"-i",&nbsp;<span class="hljs-string">"--image"):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_image&nbsp;=&nbsp;v<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;k&nbsp;<span class="hljs-keyword">in&nbsp;(<span class="hljs-string">"-t",&nbsp;<span class="hljs-string">"--tiles_dir"):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tiles_dir&nbsp;=&nbsp;v<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;k&nbsp;<span class="hljs-keyword">in&nbsp;(<span class="hljs-string">"-o",&nbsp;<span class="hljs-string">"--outfile"):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;=&nbsp;v<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;base_image&nbsp;=&nbsp;None<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;tiles_dir&nbsp;=&nbsp;None<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for&nbsp;value&nbsp;<span class="hljs-keyword">in&nbsp;(base_image,&nbsp;tiles_dir):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;value&nbsp;<span class="hljs-keyword">is&nbsp;<span class="hljs-keyword">None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.error(WARN_INFO)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if&nbsp;output&nbsp;<span class="hljs-keyword">is&nbsp;<span class="hljs-keyword">None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;=&nbsp;<span class="hljs-string">'./mosaic.jpg'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;mosaic(base_image,&nbsp;tiles_dir,&nbsp;output)<br /></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<h2 id="h-2">注！！！***</h2>
<p><strong>这里不是直接运行的！这里你要在终端使用！</strong></p>
<p>**命令：python mosaic_v2.py -i "D:\image\pic.jpg" -t "D:\image"</p>
<p><img title="" src="./images/python实现马赛克拼图！0.png" alt="" /></p>
<h2 id="h-3">程序原图：</h2>
<p><img title="" src="./images/python实现马赛克拼图！1.png" alt="" /></p>
<h2 id="h-4"><strong><em>效果图：</em></strong></h2>
<p><img title="" src="./images/python实现马赛克拼图！2.png" alt="" /></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>