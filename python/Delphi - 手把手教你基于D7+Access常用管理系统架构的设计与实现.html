<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现</center></div><div class='banquan'>原文出处:本文由博客园博主Jeremy.Wu提供。<br/>
原文连接:https://www.cnblogs.com/jeremywucnblog/p/12022001.html</div><br>
    <h2><span style="color: #008080;"><strong>前言</strong></span></h2>
<p><span style="font-family: 隶书;">　　<span style="font-family: 宋体; font-size: 14px;">从事软件开发工作好多年了，学的越深入越觉得自己无知，所以还是要对知识保持敬畏之心，活到老，学到老！</span></span></p>
<p><span style="font-family: 宋体; font-size: 14px;">健身和代码一样都不能少，身体是革命的本钱，特别是我们这种高危工种，所以小伙伴们运动起来！有没有健身撸铁，体脂现在是多少呀？明年（2020/03/22）徐州的马拉松有没有报名呀！？</span></p>
<p><span style="font-family: 宋体; font-size: 14px;">　　扯的有点远了，接下来我将抽三天时间手把手教你基于Delphi7+Access，同时搭配第三方控件RC、AlphaControl（第三方控件主要用于美化界面），完成通用管理系统架构的设计。骚年，想想是不是还有点小激动？</span></p>
<p style="text-align: center;">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现0.png" alt="" />&nbsp;</p>
<hr />
<h2>&nbsp;<span style="color: #008080;"><strong>涉及知识点</strong></span></h2>
<ul>
<li><span style="font-family: 宋体; font-size: 14px;">Access数据库建立与关键表结构设计</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">Delphi ADOConnection动态连接Access数据库</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">Delphi前台fsMDIForm和fsMDIChild窗体设计</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">dxBarManager方式通用菜单架构设计</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">主界面常见状态栏涉及与动态更新（软件版本信息、时间状态信息、登录组信息、滚动信息、当前时间...）</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">Delphi通用登录界面设计及主界面载入交互</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">MD5方式验证和保存密码</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">动态窗体菜单列表（打开窗体事件、销毁窗体事件）</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">RzCheckTree方式设计常见用户权限</span></li>
<li><span style="font-family: 宋体; font-size: 14px;">imageList图标库</span></li>
<li><span style="font-family: 楷体;"><span style="font-family: 隶书; font-size: 16px;"><span style="font-family: 宋体; font-size: 14px;">第三方控件：RC、AlphaControl皮肤控件</span>　</span>　</span></li>
</ul>
<h3><span style="color: #0000ff; font-family: 楷体;"><strong>看到这么多知识点是不是感觉有点晕啊！</strong></span></h3>
<h3><strong><span style="color: #008080;"><span style="color: #0000ff;"><span style="font-family: 楷体;">没关系，接下来我们一步一步实现！注意我们的口号，保持对知识的敬畏之心！</span>　</span>　</span></strong></h3>
<p style="text-align: center;"><strong><span style="color: #008080;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现1.png" alt="" /></span></strong></p>
<hr />
<h2>&nbsp;<strong><span style="color: #008080;">整体设计方案</span></strong></h2>
<p><span style="font-family: 隶书;"><strong><span style="color: #008080;">　　</span></strong><span style="color: #008080; font-family: 宋体; font-size: 14px;"><span style="color: #000000;">这个是我们系统实现部分的一个设计方案，因为系统是通用的嘛，所以这里我就叫它Common Management System了，下面简称CMS。</span></span></span></p>
<p style="text-align: center;">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现2.png" alt="" /></p>
<p><span data-mce-=""><span data-mce-="">　　<span style="font-family: 宋体; font-size: 14px;">这里暂不做DFEMA和PFEMA的深层次分析，有BUG的系统才是好系统，不然还要开发和维护人员做什么？（客户小姐姐：呸，渣男！）</span></span></span></p>
<p style="text-align: center;"><span data-mce-=""><span data-mce-="">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现3.png" alt="" /></span></span>&nbsp;</p>
<hr />
<h2>&nbsp;<strong><span style="color: #008080;">项目实现</span></strong></h2>
<p>　<span style="font-size: 16px;">　<span style="font-family: 宋体; font-size: 14px;">骚年，扶好了，<span style="text-decoration: line-through;">我要教你开车了</span>，啊呸，我要教你开发了。</span></span></p>
<h3><span style="color: #008080;">Access数据库建立与关键表结构设计&nbsp;</span></h3>
<p>　　<span style="font-family: 宋体; font-size: 14px;">创建一个Access文件，命名为DataX.mdb，再创建两张表，分别命名为sysUser和sysUserAuthority，其中ID栏位自动生成，VDate栏位为日期格式，其余栏位均为长文本根式，并添加如下数据，如下图。</span></p>
<p style="text-align: center;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现4.png" alt="" /></p>
<p style="text-align: center;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现5.png" alt="" />&nbsp;</p>
<hr />
<p>&nbsp;<span style="color: #008080;"><strong>Delphi ADOConnection动态连接Access数据库</strong></span>&nbsp;</p>
<p><span style="color: #008080;">　　<span style="color: #000000; font-family: 宋体; font-size: 14px;">启动Delphi7，新建一个项目，分别命名为：工程文件命名为：CommonManagementSystem.dpr，单元文件命名为：uMain.pas，主窗体命名为：MainFrm。</span></span></p>
<p><span style="color: #008080; font-family: 宋体; font-size: 14px;"><span style="color: #000000;">然后保存，注意文件的保存位置，因为接下来连接Access数据库时需要根据相对路径来，参考下图。</span></span></p>
<p style="text-align: center;"><span style="color: #008080;"><span style="color: #000000; font-family: 隶书; font-size: 16px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现6.png" alt="" /></span></span></p>
<p style="text-align: left;"><span style="color: #008080;"><span style="color: #000000; font-family: 隶书; font-size: 16px;">　　<span style="font-family: 宋体; font-size: 14px;">然后，在主窗体上放一个ADOConnection控件<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现7.png" alt="" /></span></span></span><span style="color: #008080; font-family: 宋体; font-size: 14px;"><span style="color: #000000;">，命名为conMain。接下来在工程onShow事件中写如下代码:</span></span>&nbsp;</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TMainFrm.FormShow(Sender: TObject);
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 3</span>   <span style="color: #008000;">//</span><span style="color: #008000;"> 动态连接Access数据库</span>
<span style="color: #008080;"> 4</span>   <span style="color: #0000ff;">try</span>
<span style="color: #008080;"> 5</span>     Screen.Cursor :=<span style="color: #000000;"> crSQLWait;
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    ChDir(ExtractFilePath(Application.ExeName));
</span><span style="color: #008080;"> 7</span>     ChDir(<span style="color: #800000;">'</span><span style="color: #800000;">..</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">try</span> <span style="color: #008000;">//</span><span style="color: #008000;">动态加载数据库</span>
<span style="color: #008080;"> 9</span>       conMain.Connected :=<span style="color: #000000;"> False;
</span><span style="color: #008080;">10</span>       conMain.ConnectionString := <span style="color: #800000;">'</span><span style="color: #800000;">Provider=Microsoft.Jet.OlEDB.4.0;Data Source=</span><span style="color: #800000;">'</span> + GetCurrentDir + <span style="color: #800000;">'</span><span style="color: #800000;">\DataX\DataX.mdb</span><span style="color: #800000;">'</span> + <span style="color: #800000;">'</span><span style="color: #800000;">;User ID=admin;Password=;Persist security Info=False</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">11</span>       conMain.Connected :=<span style="color: #000000;"> True;
</span><span style="color: #008080;">12</span>       conMain.LoginPrompt :=<span style="color: #000000;"> False;
</span><span style="color: #008080;">13</span>       statusPaneAccess.Caption := <span style="color: #800000;">'</span><span style="color: #800000;">数据库已连接</span><span style="color: #800000;">'</span><span style="color: #000000;">;<span style="color: #008000;">//状态栏控件statusPane
</span></span><span style="color: #008080;">14</span>       Screen.Cursor :=<span style="color: #000000;"> crDefault;
</span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">except</span>
<span style="color: #008080;">16</span>       Screen.Cursor :=<span style="color: #000000;"> crDefault;
</span><span style="color: #008080;">17</span>       statusPaneAccess.Caption := <span style="color: #800000;">'</span><span style="color: #800000;">数据库未连接</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">18</span>       MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">数据库连接失败，请确认！</span><span style="color: #800000;">'</span>, mtError, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">20</span>     Screen.Cursor :=<span style="color: #000000;"> crDefault;
</span><span style="color: #008080;">21</span>   <span style="color: #0000ff;">except</span>
<span style="color: #008080;">22</span>     statusPaneAccess.Caption := <span style="color: #800000;">'</span><span style="color: #800000;">数据库未连接</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">23</span>     MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">数据库连接失败，请确认！</span><span style="color: #800000;">'</span>, mtError, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">24</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">25</span> <span style="color: #0000ff;">end</span>;</pre>
</div>
<p style="text-align: left;">&nbsp;<span style="color: #008080;"><span style="color: #000000; font-family: 隶书; font-size: 16px;">　&nbsp; <span style="font-family: 宋体; font-size: 14px;">OK，到这里工程动态连接Access数据库的功能已经实现了。</span></span></span></p>
<p><span style="color: #008080; font-family: 宋体; font-size: 14px;"><span style="color: #000000;">　　骚年，是不是感觉很简单，是的，你没有看错，跟着我一步步做，就是so easy！（🤫，不要忘记我们的口号）其实复杂的功能都是通过简单的功能组合起来的！所以，加油吧！骚年！</span></span></p>
<p style="text-align: center;"><span style="color: #008080;"><span style="color: #000000; font-family: 隶书; font-size: 16px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现8.png" alt="" /></span></span></p>
<hr />
<h3 style="text-align: left;"><span style="color: #008080;">Delphi前台fsMDIForm和fsMDIChild窗体设计</span></h3>
<p><span style="color: #000000; font-family: 隶书; font-size: 16px;">　　<span style="font-family: 宋体; font-size: 14px;">OK，回到主界面，在对象控制面板中选中MainFrm，单击F11，在属性控制面板中设定WindowState属性设置为wsMaximized,FormStyle属性设置为fsMDIForm，后续再建立的From，FormStyle属性都设置为fsMDIChild。</span></span></p>
<p style="text-align: center;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现9.png" alt="" /></p>
<hr />
<h3 style="text-align: left;"><span style="color: #008080;">dxBarManager方式通用菜单架构设计</span></h3>
<p><span style="font-family: 隶书; font-size: 16px;"><span style="color: #000112;">　　<span style="font-family: 宋体; font-size: 14px;">拖一个dxBarManager控件<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现10.png" alt="" /></span></span></span><span style="font-family: 宋体; font-size: 14px;"><span style="color: #000112;">到主界面，命名为dxbarManagerMain，双击该控件打开Toolbars界面，New两个Toolbar分别为菜单和快捷工具条，如下图。</span></span></p>
<p style="text-align: center;"><span style="font-family: 隶书; font-size: 16px;"><span style="color: #000112;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现11.png" alt="" /></span></span></p>
<ul>
<li style="text-align: left;"><span style="font-family: 宋体; font-size: 14px;">在控件<span style="color: #ff0000;">Commands</span>界面新增<span style="color: #ff0000;">Categories</span>分别为<span style="text-decoration: underline;">主菜单</span>、<span style="text-decoration: underline;">系统设置</span>和<span style="text-decoration: underline;">窗口</span></span></li>
<li style="text-align: left;"><span style="font-family: 宋体; font-size: 14px;">在主菜单下建立<span style="color: #ff0000;">dxBarSubItem</span>类型的菜单<span style="text-decoration: underline;">系统设置</span>和<span style="text-decoration: underline;">窗口</span></span></li>
<li style="text-align: left;"><span style="font-family: 宋体; font-size: 14px;">在系统设置菜单下建立<span style="color: #ff0000;">dxBarButton</span>类型的菜单<span style="text-decoration: underline;">系统权限设置</span>和<span style="text-decoration: underline;">帮助</span></span></li>
<li style="text-align: left;"><span style="font-family: 宋体; font-size: 14px;">在窗口菜单下建立<span style="color: #ff0000;">dxBarButton</span>类型的菜单<span style="text-decoration: underline;">窗口平铺</span>、<span style="text-decoration: underline;">窗口层叠</span>和<span style="text-decoration: underline;">窗口垂直</span>，和<span style="color: #ff0000;">dxBarListItem</span>类型的菜单<span style="text-decoration: underline;">窗口列表</span></span></li>
</ul>
<hr />
<p>&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000; font-family: 宋体; font-size: 14px;">&nbsp; 注意：这里的菜单类型不能选错！！！</span></p>
<p style="margin-left: 30px;"><span style="color: #ff0000; font-family: 宋体; font-size: 14px;">&nbsp;注意：这里的菜单类型不能选错！！！</span></p>
<p style="margin-left: 30px;"><span style="color: #ff0000; font-family: 宋体; font-size: 14px;">&nbsp;注意：这里的菜单类型不能选错！！！</span></p>
<p style="text-align: center;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现12.png" alt="" width="331" height="349" /><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现13.png" alt="" /><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现14.png" alt="" /></p>
<p><span style="font-family: 隶书; font-size: 16px;">　<span style="font-family: 宋体; font-size: 14px;">　OK，菜单设计好之后，我们选中dxbarManagerMain控件，单击F11，设置Style为bmsFlat。然后双击打开控件，选中Toolbars中菜单，单击F11，分别设置IsMainMenu、MultiLine和OneOnRow属性为True。如下图。</span></span></p>
<p style="text-align: center;"><span style="font-family: 隶书; font-size: 16px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现15.png" alt="" /></span></p>
<p style="text-align: left; margin-left: 30px;"><span style="font-family: 宋体; font-size: 14px;">OK，接下来，拖动菜单完成菜单架构设计，快捷工具条暂时不用，后续我们再介绍，请看下图。</span></p>
<p style="text-align: center; margin-left: 30px;"><span style="font-family: 隶书; font-size: 16px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现16.png" alt="" /></span>&nbsp;</p>
<hr />
<h3>&nbsp;<span style="color: #008080;"><span data-mce-="">主界面常见状态栏涉及与动态更新（软件版本信息、时间状态信息、登录组信息、滚动信息、当前时间...）<br /></span></span></h3>
<p><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-="">　　<span style="font-family: 宋体; font-size: 14px;">鼠标点击主界面空白处，单击右键选择 Add a Status Bar，添加一个statusBar控件，命名为statusBarMain，然后选中statusBar，右键单击New一些控件，分别设置其名称、对齐方式、Caption等。</span></span></span></span></p>
<p style="text-align: center;"><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-=""><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现17.png" alt="" /><br /></span></span></span></p>
<p style="text-align: left;"><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-="">　　<span style="font-family: 宋体; font-size: 14px;">最终效果，如下：</span></span></span></span></p>
<p style="text-align: center;"><sub><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-=""><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现18.png" alt="" /></span></span></span></sub></p>
<p style="text-align: left;"><sub><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-="">　　<span style="font-family: 宋体; font-size: 14px;">OK，今天就到这里了，明天，我们继续！骚年，注意<span style="background-color: #00ff00;">关注、收藏、推荐</span>，不要迷了路！！！</span></span></span></span></sub></p>
<p style="text-align: center;"><sub><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-=""><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现19.png" alt="" /></span></span></span></sub><sub><span style="color: #000000; font-family: 隶书; font-size: 16px;"><span data-mce-=""><span data-mce-=""><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现20.png" alt="" /></span></span></span></sub></p>
<hr />
<h3 style="text-align: left;"><span style="color: #008080;">Delphi通用登录界面设计及主界面载入交互</span></h3>
<p style="margin-left: 30px;"><span style="font-size: 14px;">小伙伴我回来了，看到大家的评论，不禁老泪纵横，老兵不死，就是干(⊙﹏⊙)。。。。。。。。。。。。。</span></p>
<p style="text-align: center; margin-left: 30px;"><span style="font-size: 14px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现21.png" alt="" /></span>&nbsp;</p>
<p style="text-align: left; margin-left: 30px;"><span style="font-size: 14px;">OK，打起精神我们接着昨天的内容继续。</span></p>
<p style="text-align: left;"><span style="font-size: 14px;">　　首先打开我们的工程，新建一个Form，命名为FrmLogin，然后开始进行前台布局，注意控件的命名一定要规范哈，我大概搞了一下登录界面，如下图。</span></p>
<p style="text-align: center;"><span style="font-size: 14px;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现22.png" alt="" /><br /></span></p>
<p style="text-align: left; margin-left: 30px;"><span style="font-size: 14px;">然后，我们新建一个单元文件，命名为<span style="background-color: #00ff00;">sysPublic.pas</span>，用来声明项目公用的函数、过程和变量，代码如下（注意，这里涉及到第三方控件：RC，cx）</span><span style="color: #008080; font-size: 14px;"><span style="color: #000000;">。</span></span>&nbsp;</p>
<div class="cnblogs_code" style="margin-left: 30px;" onclick="cnblogs_code_show('0a9acd9f-e455-4958-b350-ca3194e0b9de')"><img id="code_img_closed_0a9acd9f-e455-4958-b350-ca3194e0b9de" class="code_img_closed" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现23.png" alt="" /><img id="code_img_opened_0a9acd9f-e455-4958-b350-ca3194e0b9de" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('0a9acd9f-e455-4958-b350-ca3194e0b9de',event)" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现24.png" alt="" />
<div id="cnblogs_code_open_0a9acd9f-e455-4958-b350-ca3194e0b9de" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">unit</span><span style="color: #000000;"> SysPublic;
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> <span style="color: #0000ff;">interface</span>
<span style="color: #008080;">  4</span> 
<span style="color: #008080;">  5</span> <span style="color: #0000ff;">uses</span>
<span style="color: #008080;">  6</span> <span style="color: #000000;">  Windows, Messages, SysUtils, Dialogs, Forms,
</span><span style="color: #008080;">  7</span> <span style="color: #000000;">  Classes, Variants, StdCtrls, Db,
</span><span style="color: #008080;">  8</span> <span style="color: #000000;">  Controls, WinSock, ShellApi, jpeg, graphics, TypInfo,
</span><span style="color: #008080;">  9</span> <span style="color: #000000;">  ExtCtrls, ComObj, ComCtrls, IdSMTP, IdMessage,
</span><span style="color: #008080;"> 10</span> <span style="color: #000000;">  RzChkLst, ActnList, DBCtrls, RzTreeVw, RzGroupBar, DateUtils,
</span><span style="color: #008080;"> 11</span> <span style="color: #000000;">  StrUtils, Math, RzPanel, cxStyles, RzDBCmbo, RzDBBnEd,
</span><span style="color: #008080;"> 12</span> <span style="color: #000000;">  cxCustomData, cxGraphics, cxFilter, cxData, cxDataStorage, cxEdit,
</span><span style="color: #008080;"> 13</span> <span style="color: #000000;">  cxDBData, cxTextEdit, cxGridCustomTableView, cxGridTableView,
</span><span style="color: #008080;"> 14</span> <span style="color: #000000;">  cxGridDBTableView, Ora, MemDS, DBAccess, cxGridLevel, cxClasses, dxBar,
</span><span style="color: #008080;"> 15</span> <span style="color: #000000;">  cxControls, cxGridCustomView, cxGrid, cxDropDownEdit, cxGridBandedTableView, cxGridDBBandedTableView, cxGridExportLink, Clipbrd,
</span><span style="color: #008080;"> 16</span> <span style="color: #000000;">  IdBaseComponent, IdComponent, RzDBEdit, IdHash, IdHashMessageDigest,
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">  IdFTP, IdFTPCommon, nb30, CwMboxLib_TLB, TlHelp32, winspool, Registry,
</span><span style="color: #008080;"> 18</span> <span style="color: #000000;">  IdIPWatch, ADODB;
</span><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;"> 20</span>   sysMsgBuffer, <span style="color: #008000;">//</span><span style="color: #008000;">消息缓存</span>
<span style="color: #008080;"> 21</span>     sysWorkNO, <span style="color: #008000;">//</span><span style="color: #008000;">工号</span>
<span style="color: #008080;"> 22</span>     sysUserName, <span style="color: #008000;">//</span><span style="color: #008000;">用户名称</span>
<span style="color: #008080;"> 23</span>     sysGroupName, <span style="color: #008000;">//</span><span style="color: #008000;">登录组</span>
<span style="color: #008080;"> 24</span>     sysRealName, <span style="color: #008000;">//</span><span style="color: #008000;">用户姓名</span>
<span style="color: #008080;"> 25</span>     sysMac, <span style="color: #008000;">//</span><span style="color: #008000;">MAC地址</span>
<span style="color: #008080;"> 26</span>     sysIP, <span style="color: #008000;">//</span><span style="color: #008000;">IP地址</span>
<span style="color: #008080;"> 27</span>     sysDataXPath: <span style="color: #0000ff;">string</span>; <span style="color: #008000;">//</span><span style="color: #008000;">数据库地址</span>
<span style="color: #008080;"> 28</span> <span style="color: #0000ff;">function</span> GetMd5Str(ContenStr: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span>; <span style="color: #008000;">//</span><span style="color: #008000;">获取Md5码</span>
<span style="color: #008080;"> 29</span> <span style="color: #0000ff;">procedure</span> OpenForm(FormClass: TFormClass; <span style="color: #0000ff;">var</span><span style="color: #000000;"> fm; AOwner: TComponent);
</span><span style="color: #008080;"> 30</span> <span style="color: #0000ff;">procedure</span> ExecSQL(sSQL: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 31</span> <span style="color: #0000ff;">procedure</span> SetParam(V_Qry: TADOQuery; V_Param: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 32</span> <span style="color: #0000ff;">procedure</span> Openquery(Q: TADOQuery; V_Sql: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 33</span> <span style="color: #0000ff;">procedure</span> ComboAdd(Sender: Tstrings; SQLStr: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 34</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> ShowDxBarManagerMenu();
</span><span style="color: #008080;"> 35</span> 
<span style="color: #008080;"> 36</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> GetIPAddress(): Variant;
</span><span style="color: #008080;"> 37</span> <span style="color: #0000ff;">function</span> SaveToExcel(GridMain: TcxGrid; FileName: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 38</span> <span style="color: #0000ff;">function</span> GetSql(Ssql, V_Param: <span style="color: #0000ff;">string</span><span style="color: #000000;">): Variant;
</span><span style="color: #008080;"> 39</span> <span style="color: #0000ff;">function</span> GetPosName(sName: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 40</span> 
<span style="color: #008080;"> 41</span> <span style="color: #0000ff;">implementation</span>
<span style="color: #008080;"> 42</span> <span style="color: #0000ff;">uses</span><span style="color: #000000;"> uMain;
</span><span style="color: #008080;"> 43</span> 
<span style="color: #008080;"> 44</span> <span style="color: #0000ff;">procedure</span> OpenForm(FormClass: TFormClass; <span style="color: #0000ff;">var</span><span style="color: #000000;"> fm; AOwner: TComponent);
</span><span style="color: #008080;"> 45</span> <span style="color: #008000;">{</span><span style="color: #008000;">根据传递过来的参数，打开相应的窗体</span><span style="color: #008000;">}</span>
<span style="color: #008080;"> 46</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;"> 47</span> <span style="color: #000000;">  i: integer;
</span><span style="color: #008080;"> 48</span> <span style="color: #000000;">  Child: TForm;
</span><span style="color: #008080;"> 49</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 50</span>   <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> Screen.FormCount - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">if</span> Screen.Forms[i].ClassType = FormClass <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 53</span>             <span style="color: #008000;">{</span><span style="color: #008000;">检查窗体是否已经打开，如果没有打开，打开它，
</span><span style="color: #008080;"> 54</span> <span style="color: #008000;">            如果已经打开，让它正常显示即可</span><span style="color: #008000;">}</span>
<span style="color: #008080;"> 55</span>       Child :=<span style="color: #000000;"> Screen.Forms[i];
</span><span style="color: #008080;"> 56</span>       <span style="color: #0000ff;">if</span> Child.WindowState = wsMinimized <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 57</span> <span style="color: #000000;">        ShowWindow(Child.handle, SW_SHOWNORMAL)
</span><span style="color: #008080;"> 58</span>       <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 59</span> <span style="color: #000000;">        ShowWindow(Child.handle, SW_SHOWNA);
</span><span style="color: #008080;"> 60</span>       <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">not</span> Child.Visible) <span style="color: #0000ff;">then</span> Child.Visible :=<span style="color: #000000;"> True;
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">      Child.BringToFront;
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">      Child.Setfocus;
</span><span style="color: #008080;"> 63</span>       TForm(fm) :=<span style="color: #000000;"> Child;
</span><span style="color: #008080;"> 64</span> <span style="color: #000000;">      exit;
</span><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 66</span>   Child :=<span style="color: #000000;"> TForm(FormClass.NewInstance);
</span><span style="color: #008080;"> 67</span>   TForm(fm) :=<span style="color: #000000;"> Child;
</span><span style="color: #008080;"> 68</span>   Child.<span style="color: #0000ff;">Create</span><span style="color: #000000;">(AOwner);
</span><span style="color: #008080;"> 69</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 70</span> 
<span style="color: #008080;"> 71</span> <span style="color: #0000ff;">procedure</span> SetParam(V_Qry: TADOQuery; V_Param: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 72</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;"> 73</span> <span style="color: #000000;">  i: Integer;
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">  S: tstringlist;
</span><span style="color: #008080;"> 75</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 76</span>   s := tstringlist.<span style="color: #0000ff;">Create</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">  s.Clear;
</span><span style="color: #008080;"> 78</span>   <span style="color: #0000ff;">if</span> v_Param &lt;&gt; <span style="color: #800000;">''</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 79</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 80</span>     s.Text := stringreplace(v_Param, <span style="color: #800000;">'</span><span style="color: #800000;">[;]</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">[KEY]</span><span style="color: #800000;">'</span><span style="color: #000000;">, [rfReplaceAll]);
</span><span style="color: #008080;"> 81</span>     s.Text := stringreplace(s.Text, <span style="color: #800000;">'</span><span style="color: #800000;">;</span><span style="color: #800000;">'</span>, #<span style="color: #800080;">13</span> + #<span style="color: #800080;">10</span><span style="color: #000000;">, [rfReplaceAll]);
</span><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">if</span> S.Count &gt; V_Qry.Fields.Count <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 84</span>       ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">参数个数超过要求:</span><span style="color: #800000;">'</span> + V_Param + <span style="color: #800000;">'</span><span style="color: #800000;">[</span><span style="color: #800000;">'</span> + V_Qry.SQL.Text + <span style="color: #800000;">'</span><span style="color: #800000;">]</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 85</span> <span style="color: #000000;">      Abort;
</span><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 87</span>     <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> s.Count - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 88</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 89</span>       <span style="color: #0000ff;">if</span> (V_Qry.FieldDefList[i].Name = <span style="color: #800000;">'</span><span style="color: #800000;">RQ1</span><span style="color: #800000;">'</span>) <span style="color: #0000ff;">or</span> (V_Qry.FieldDefList[i].Name = <span style="color: #800000;">'</span><span style="color: #800000;">RQ2</span><span style="color: #800000;">'</span>) <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 90</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 91</span>         V_Qry.FieldDefList[i].Name :=<span style="color: #000000;"> s[i];
</span><span style="color: #008080;"> 92</span>       <span style="color: #0000ff;">end</span>
<span style="color: #008080;"> 93</span>       <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 94</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 95</span>         V_Qry.FieldDefList[i].Name := stringreplace(s[i], <span style="color: #800000;">'</span><span style="color: #800000;">[KEY]</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">;</span><span style="color: #800000;">'</span><span style="color: #000000;">, [rfReplaceAll]);
</span><span style="color: #008080;"> 96</span>       <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 98</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 99</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">100</span> 
<span style="color: #008080;">101</span> <span style="color: #0000ff;">procedure</span> OpenQuery(Q: TADOQuery; V_Sql: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;">102</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">103</span> <span style="color: #000000;">  Q.Close;
</span><span style="color: #008080;">104</span>   Q.SQL.Text :=<span style="color: #000000;"> V_Sql;
</span><span style="color: #008080;">105</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">106</span> 
<span style="color: #008080;">107</span> <span style="color: #0000ff;">procedure</span> ComboAdd(Sender: Tstrings; SQLStr: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;">108</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">109</span> <span style="color: #000000;">  i, r: Integer;
</span><span style="color: #008080;">110</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">111</span>   <span style="color: #0000ff;">with</span> MainFrm.qryTmp <span style="color: #0000ff;">do</span>
<span style="color: #008080;">112</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">113</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">114</span> <span style="color: #000000;">    SQL.Clear;
</span><span style="color: #008080;">115</span> <span style="color: #000000;">    SQL.Add(SQLStr);
</span><span style="color: #008080;">116</span> <span style="color: #000000;">    Open;
</span><span style="color: #008080;">117</span> <span style="color: #000000;">    First;
</span><span style="color: #008080;">118</span>     R :=<span style="color: #000000;"> RecordCount;
</span><span style="color: #008080;">119</span>     <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">1</span> <span style="color: #0000ff;">to</span> r <span style="color: #0000ff;">do</span>
<span style="color: #008080;">120</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">121</span>       Sender.Add(Fields[<span style="color: #800080;">0</span><span style="color: #000000;">].AsString);
</span><span style="color: #008080;">122</span> <span style="color: #000000;">      Next;
</span><span style="color: #008080;">123</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">124</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">125</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">126</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">127</span> 
<span style="color: #008080;">128</span> <span style="color: #0000ff;">procedure</span> ExecSQL(sSQL: <span style="color: #0000ff;">string</span><span style="color: #000000;">);
</span><span style="color: #008080;">129</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">130</span> <span style="color: #000000;">  MainFrm.qryTmp.Close;
</span><span style="color: #008080;">131</span>   MainFrm.qryTmp.SQL.Text :=<span style="color: #000000;"> sSQL;
</span><span style="color: #008080;">132</span> <span style="color: #000000;">  MainFrm.qryTmp.ExecSQL;
</span><span style="color: #008080;">133</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">134</span> 
<span style="color: #008080;">135</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> GetIPAddress(): Variant;
</span><span style="color: #008080;">136</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">137</span> <span style="color: #000000;">  IPAddress: TIdIPWatch;
</span><span style="color: #008080;">138</span>   IPAdd_Buff: <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">139</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">140</span>   IPAddress := TIdIPWatch.<span style="color: #0000ff;">Create</span>(<span style="color: #0000ff;">nil</span><span style="color: #000000;">);
</span><span style="color: #008080;">141</span>   IPAdd_Buff :=<span style="color: #000000;"> IPAddress.LocalIP;
</span><span style="color: #008080;">142</span>   <span style="color: #0000ff;">if</span> IPAdd_Buff &lt;&gt; <span style="color: #800000;">''</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">143</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">144</span>     Result :=<span style="color: #000000;"> IPAdd_Buff;
</span><span style="color: #008080;">145</span>   <span style="color: #0000ff;">end</span>
<span style="color: #008080;">146</span>   <span style="color: #0000ff;">else</span>
<span style="color: #008080;">147</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">148</span>     Result := <span style="color: #800000;">''</span><span style="color: #000000;">;
</span><span style="color: #008080;">149</span>     ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">获取IP地址错误，请确认！</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">150</span> <span style="color: #000000;">    Abort;
</span><span style="color: #008080;">151</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">152</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">153</span> 
<span style="color: #008080;">154</span> <span style="color: #0000ff;">function</span> SaveToExcel(GridMain: TcxGrid; FileName: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">155</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">156</span> <span style="color: #000000;">  SaveFileDialog: TSaveDialog;
</span><span style="color: #008080;">157</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">158</span>   SaveFileDialog := TSaveDialog.<span style="color: #0000ff;">Create</span>(<span style="color: #0000ff;">nil</span><span style="color: #000000;">);
</span><span style="color: #008080;">159</span>   SaveFileDialog.FileName :=<span style="color: #000000;"> FileName;
</span><span style="color: #008080;">160</span>   SaveFileDialog.Filter := <span style="color: #800000;">'</span><span style="color: #800000;">*.xls</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">161</span>   <span style="color: #0000ff;">if</span> SaveFileDialog.Execute <span style="color: #0000ff;">then</span>
<span style="color: #008080;">162</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">163</span>     <span style="color: #0000ff;">if</span> pos(<span style="color: #800000;">'</span><span style="color: #800000;">.XLS</span><span style="color: #800000;">'</span>, UpperCase(SaveFileDialog.FileName)) &lt;= <span style="color: #800080;">0</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">164</span>       SaveFileDialog.FileName := SaveFileDialog.FileName + <span style="color: #800000;">'</span><span style="color: #800000;">.XLS</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">165</span> <span style="color: #000000;">    ExportGridToExcel(SaveFileDialog.FileName, gridMain);
</span><span style="color: #008080;">166</span>     ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">数据已成功导出到您指定的目录中</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">167</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">168</span>   Result :=<span style="color: #000000;"> SaveFileDialog.FileName;
</span><span style="color: #008080;">169</span> <span style="color: #000000;">  SaveFileDialog.Free;
</span><span style="color: #008080;">170</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">171</span> 
<span style="color: #008080;">172</span> <span style="color: #0000ff;">function</span> GetSql(Ssql, V_Param: <span style="color: #0000ff;">string</span><span style="color: #000000;">): Variant;
</span><span style="color: #008080;">173</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">174</span> <span style="color: #000000;">  S: Tstringlist;
</span><span style="color: #008080;">175</span> <span style="color: #000000;">  I: Integer;
</span><span style="color: #008080;">176</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">177</span>   S := Tstringlist.<span style="color: #0000ff;">Create</span><span style="color: #000000;">;
</span><span style="color: #008080;">178</span> <span style="color: #000000;">  S.Clear;
</span><span style="color: #008080;">179</span> <span style="color: #000000;">  OpenQuery(MainFrm.qryTmp, Ssql);
</span><span style="color: #008080;">180</span> <span style="color: #000000;">  SetParam(MainFrm.qryTmp, V_Param);
</span><span style="color: #008080;">181</span> <span style="color: #000000;">  MainFrm.qryTmp.Open;
</span><span style="color: #008080;">182</span>   <span style="color: #0000ff;">if</span> MainFrm.qryTmp.IsEmpty <span style="color: #0000ff;">then</span>
<span style="color: #008080;">183</span>     Result := <span style="color: #800000;">''</span>
<span style="color: #008080;">184</span>   <span style="color: #0000ff;">else</span>
<span style="color: #008080;">185</span>     Result := MainFrm.qryTmp.Fields[<span style="color: #800080;">0</span><span style="color: #000000;">].Value;
</span><span style="color: #008080;">186</span>   <span style="color: #0000ff;">if</span> VarIsNull(result) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">187</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">188</span>     result := <span style="color: #800000;">''</span><span style="color: #000000;">;
</span><span style="color: #008080;">189</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">190</span> <span style="color: #000000;">  MainFrm.qryTmp.Close;
</span><span style="color: #008080;">191</span> <span style="color: #000000;">  MainFrm.qryTmp.Free;
</span><span style="color: #008080;">192</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">193</span> 
<span style="color: #008080;">194</span> <span style="color: #0000ff;">function</span> GetPosName(sName: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">195</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">196</span>   s: <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">197</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">198</span>   s :=<span style="color: #000000;"> Trim(sName);
</span><span style="color: #008080;">199</span>   <span style="color: #0000ff;">if</span> pos(<span style="color: #800000;">'</span><span style="color: #800000;">(</span><span style="color: #800000;">'</span>, s) &gt; <span style="color: #800080;">0</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">200</span>     s := copy(s, <span style="color: #800080;">0</span>, pos(<span style="color: #800000;">'</span><span style="color: #800000;">(</span><span style="color: #800000;">'</span>, s) - <span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">201</span>   Result :=<span style="color: #000000;"> s;
</span><span style="color: #008080;">202</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">203</span> 
<span style="color: #008080;">204</span> 
<span style="color: #008080;">205</span> <span style="color: #008000;">//</span><span style="color: #008000;">获取MD5码</span>
<span style="color: #008080;">206</span> <span style="color: #008000;">//</span><span style="color: #008000;">ContenStr：原码，返回MD5码</span>
<span style="color: #008080;">207</span> 
<span style="color: #008080;">208</span> <span style="color: #0000ff;">function</span> GetMd5Str(ContenStr: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">209</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">210</span> <span style="color: #000000;">  RegMd5: TIdHashMessageDigest5;
</span><span style="color: #008080;">211</span> <span style="color: #000000;">  RegDigest: T4x4LongWordRecord;
</span><span style="color: #008080;">212</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">213</span>   RegMd5 := TIdHashMessageDigest5.<span style="color: #0000ff;">Create</span><span style="color: #000000;">;
</span><span style="color: #008080;">214</span>   RegDigest :=<span style="color: #000000;"> RegMd5.HashValue(ContenStr);
</span><span style="color: #008080;">215</span>   Result :=<span style="color: #000000;"> LowerCase(RegMd5.AsHex(RegDigest));
</span><span style="color: #008080;">216</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">217</span> 
<span style="color: #008080;">218</span> <span style="color: #008000;">//</span><span style="color: #008000;">刷线主界面菜单权限</span>
<span style="color: #008080;">219</span> 
<span style="color: #008080;">220</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> ShowDxBarManagerMenu();
</span><span style="color: #008080;">221</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">222</span> <span style="color: #000000;">  dxBar: TdxBarManager;
</span><span style="color: #008080;">223</span> <span style="color: #000000;">  i, l, lIndex: integer;
</span><span style="color: #008080;">224</span>   sCap, sSql, m_menu_group, m_menu: <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #008080;">225</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">226</span>   <span style="color: #0000ff;">with</span> MainFrm.qryTmp <span style="color: #0000ff;">do</span>
<span style="color: #008080;">227</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">228</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">229</span> <span style="color: #000000;">    SQL.Clear;
</span><span style="color: #008080;">230</span>     SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">select a.GroupName, b.MenuName, a.UserName from sysUser a, sysUserAuthority b where a.GroupName = b.GroupName and a.UserName=:UserName and b.SystemName=:SystemName</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">231</span>     Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">UserName</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> sysUserName;
</span><span style="color: #008080;">232</span>     Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">SystemName</span><span style="color: #800000;">'</span>).Value := <span style="color: #800000;">'</span><span style="color: #800000;">CMS</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">233</span> 
<span style="color: #008080;">234</span> <span style="color: #000000;">    Open;
</span><span style="color: #008080;">235</span>     dxBar :=<span style="color: #000000;"> MainFrm.dxBarManagerMain;
</span><span style="color: #008080;">236</span>     <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">1</span> <span style="color: #0000ff;">to</span> dxBar.Categories.Count - <span style="color: #800080;">2</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;">237</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">238</span>       m_menu_group :=<span style="color: #000000;"> dxBar.Categories.Strings[i];
</span><span style="color: #008080;">239</span>       <span style="color: #0000ff;">for</span> l := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> dxBar.ItemCount - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;">240</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">241</span>         <span style="color: #0000ff;">if</span> dxBar.Items[l] <span style="color: #0000ff;">is</span> TdxBarButton <span style="color: #0000ff;">then</span>
<span style="color: #008080;">242</span>         <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">243</span>           <span style="color: #0000ff;">if</span> dxBar.Items[l].Category = i <span style="color: #0000ff;">then</span>
<span style="color: #008080;">244</span>           <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">245</span>             sCap :=<span style="color: #000000;"> dxBar.Items[l].Caption;
</span><span style="color: #008080;">246</span>             lIndex :=<span style="color: #000000;"> dxBar.Items[l].Index;
</span><span style="color: #008080;">247</span>             m_menu :=<span style="color: #000000;"> sCap;
</span><span style="color: #008080;">248</span>             <span style="color: #0000ff;">if</span> Locate(<span style="color: #800000;">'</span><span style="color: #800000;">MenuName</span><span style="color: #800000;">'</span>, sCap, []) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">249</span>               dxBar.Items[l].Enabled :=<span style="color: #000000;"> true
</span><span style="color: #008080;">250</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">251</span>               dxBar.Items[l].Enabled :=<span style="color: #000000;"> false;
</span><span style="color: #008080;">252</span>           <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">253</span>         <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">254</span>       <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">255</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">256</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">257</span> 
<span style="color: #008080;">258</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">259</span> 
<span style="color: #008080;">260</span> <span style="color: #0000ff;">end</span>.</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p style="text-align: left; margin-left: 30px;">&nbsp;<span style="color: #008080; font-size: 14px;"><span style="color: #000000;">好，我们在主窗体OnShow事件中（连接Access数据库下面），写如下代码，功能是：主窗体Show之前，登录窗体先弹出来。</span></span><span style="color: #008080; font-size: 14px;"><span style="color: #000000;">　　</span></span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;">1</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 系统登录</span>
<span style="color: #008080;">2</span>   <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> assigned(FrmLogin) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">3</span>     FrmLogin :=<span style="color: #000000;"> TFrmLogin.create(Application);
</span><span style="color: #008080;">4</span>   FrmLogin.ShowModal;</pre>
</div>
<p>　　然后，开始写登录事件，同时，更新主界面菜单权限和状态栏信息。　　</p>
<div class="cnblogs_code" style="margin-left: 30px;" onclick="cnblogs_code_show('09e751c9-ec2e-478f-851c-8c093990ea78')"><img id="code_img_closed_09e751c9-ec2e-478f-851c-8c093990ea78" class="code_img_closed" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现23.png" alt="" /><img id="code_img_opened_09e751c9-ec2e-478f-851c-8c093990ea78" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('09e751c9-ec2e-478f-851c-8c093990ea78',event)" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现24.png" alt="" />
<div id="cnblogs_code_open_09e751c9-ec2e-478f-851c-8c093990ea78" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 2</span>    <span style="color: #008000;">//</span><span style="color: #008000;"> 检查录入完整性</span>
<span style="color: #008080;"> 3</span>   <span style="color: #0000ff;">if</span> (Trim(edtUserName.Text) = <span style="color: #800000;">''</span>) <span style="color: #0000ff;">or</span> (Trim(edtPassCode.Text) = <span style="color: #800000;">''</span>) <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 4</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 5</span>     MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">用户名或者密码不能为空，请确认！</span><span style="color: #800000;">'</span>, mtWarning, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    edtUserName.SetFocus;
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    Abort;
</span><span style="color: #008080;"> 8</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 9</span>   <span style="color: #008000;">//</span><span style="color: #008000;"> 开始登录</span>
<span style="color: #008080;">10</span>   <span style="color: #0000ff;">with</span> qryLogin <span style="color: #0000ff;">do</span>
<span style="color: #008080;">11</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">12</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">13</span> <span style="color: #000000;">    SQL.Clear;
</span><span style="color: #008080;">14</span>     SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">select * from sysUser t where UserName=:UserName and PassCode =:PassCode</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">15</span>     Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">UserName</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> Trim(edtUserName.Text);
</span><span style="color: #008080;">16</span>     Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">PassCode</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> GetMd5Str(Trim(edtPassCode.Text));
</span><span style="color: #008080;">17</span> <span style="color: #000000;">    Open;
</span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">if</span> FindFirst <span style="color: #0000ff;">then</span>
<span style="color: #008080;">19</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">20</span>       sysUserName := FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">UserName</span><span style="color: #800000;">'</span><span style="color: #000000;">).AsString;
</span><span style="color: #008080;">21</span>       sysGroupName := FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">GroupName</span><span style="color: #800000;">'</span><span style="color: #000000;">).AsString; ;
</span><span style="color: #008080;">22</span>       sysWorkNO := FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">WorkNO</span><span style="color: #800000;">'</span><span style="color: #000000;">).AsString; ;
</span><span style="color: #008080;">23</span>       sysRealName := FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">RealName</span><span style="color: #800000;">'</span><span style="color: #000000;">).AsString;
</span><span style="color: #008080;">24</span>        <span style="color: #008000;">//</span><span style="color: #008000;"> 刷新菜单权限</span>
<span style="color: #008080;">25</span> <span style="color: #000000;">      ShowDxBarManagerMenu();
</span><span style="color: #008080;">26</span>       <span style="color: #008000;">//</span><span style="color: #008000;"> 更新状态栏信息</span>
<span style="color: #008080;">27</span>       MainFrm.statusPaneUser.Caption := <span style="color: #800000;">'</span><span style="color: #800000;">登录用户[</span><span style="color: #800000;">'</span> + sysUserName + <span style="color: #800000;">'</span><span style="color: #800000;">] 登陆组[</span><span style="color: #800000;">'</span> + sysGroupName + <span style="color: #800000;">'</span><span style="color: #800000;">]</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">28</span>       FrmLogin.Tag := <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">29</span> <span style="color: #000000;">      FrmLogin.Close;
</span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">end</span>
<span style="color: #008080;">31</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">32</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">33</span>       MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">用户名或者密码不正确，请确认！</span><span style="color: #800000;">'</span>, mtWarning, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">34</span> <span style="color: #000000;">      edtUserName.SetFocus;
</span><span style="color: #008080;">35</span> <span style="color: #000000;">      Abort;
</span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">37</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span> <span style="color: #0000ff;">end</span>;</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;　　我们这里用<span style="font-family: 微软雅黑; font-size: small;">FrmLogin.Tag作为标记登录成功与否的标记，默认情况下设置为0，密码验证通过时，tag赋值为1，然后在FrmLogin的Close事件中判断其是否为1，否则直接终止程序。</span><span style="font-family: 微软雅黑; font-size: small;">　　</span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;">1</span> <span style="color: #0000ff;">procedure</span> TFrmLogin.FormClose(Sender: TObject; <span style="color: #0000ff;">var</span><span style="color: #000000;"> Action: TCloseAction);
</span><span style="color: #008080;">2</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">3</span>   <span style="color: #0000ff;">if</span> FrmLogin.Tag &lt;&gt; <span style="color: #800080;">1</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">4</span> <span style="color: #000000;">    Application.Terminate;
</span><span style="color: #008080;">5</span> <span style="color: #0000ff;">end</span>;</pre>
</div>
<p style="text-align: left;">　　OK，看下现在的效果。　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现27.png" alt="" /></p>
<p>&nbsp;　　<span style="font-family: 微软雅黑; font-size: small;">注意，我这里手工在Access数据库中增加了一个用户admin，分组为<span style="text-decoration: underline;"><span style="background-color: #00ff00;">查询组</span></span>，其菜单权限相比于<span style="text-decoration: underline;"><span style="background-color: #00ff00;">管理组</span></span>，少了一个<span style="text-decoration: underline; background-color: #99cc00;">帮助</span>的菜单。那小伙伴该问了，后续所有的权限都要在Access里面改？？当然不是了，下面我们会继续讲解权限的管理。</span></p>
<p style="text-align: center;"><span style="font-family: 微软雅黑; font-size: small;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现28.png" alt="" /></span>　　　　</p>
<hr />
<p><span style="font-size: 15px;"><strong><span style="color: #008080;">MD5方式验证和保存密码</span></strong></span>　　</p>
<p>　　这里相信你在上面登录相关代码中已经看到了，MD5转换就是一个函数搞定的事。保存密码也是一样，直接调用MD5转换函数进行转化，然后再保存到数据库即可。　</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;">获取MD5码</span><span style="color: #008000;">
//</span><span style="color: #008000;">ContenStr：原码，返回MD5码</span><span style="color: #008000;">
//</span><span style="color: #008000;">需要引用 IdHash, IdHashMessageDigest单元</span>
<span style="color: #0000ff;">function</span> GetMd5Str(ContenStr: <span style="color: #0000ff;">string</span>): <span style="color: #0000ff;">string</span><span style="color: #000000;">;
</span><span style="color: #0000ff;">var</span><span style="color: #000000;">
  RegMd5: TIdHashMessageDigest5;
  RegDigest: T4x4LongWordRecord;
</span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
  RegMd5 :</span>= TIdHashMessageDigest5.<span style="color: #0000ff;">Create</span><span style="color: #000000;">;
  RegDigest :</span>=<span style="color: #000000;"> RegMd5.HashValue(ContenStr);
  Result :</span>=<span style="color: #000000;"> LowerCase(RegMd5.AsHex(RegDigest));
</span><span style="color: #0000ff;">end</span>;</pre>
</div>
<p>&nbsp;</p>
<hr />
<h3>&nbsp;<span style="color: #008080;">动态窗体菜单列表（打开窗体事件、销毁窗体事件）</span></h3>
<p><span style="font-family: 微软雅黑; font-size: small;">　　首先，根据实际情况，一般除主窗体之外的所有窗体的FormStyle属性都要设置成fsMDIChild，然后在Project-Options中将子窗体移到右边。如下图。</span></p>
<p style="text-align: center;"><span style="font-family: 微软雅黑; font-size: small;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现29.png" alt="" /></span></p>
<p style="text-align: left;"><span style="font-family: 微软雅黑; font-size: small;">　　另外，分别在子</span>窗体的Create、Close和<span style="font-family: 微软雅黑; font-size: small;">Destroy</span>写如下事件（注意主<span style="color: #000000; text-decoration: underline; background-color: #33cccc;">界面窗体</span>列表菜单的名称为dxBarListWindows）：　</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmMDIChildTest.FormClose(Sender: TObject;
</span><span style="color: #008080;"> 2</span>   <span style="color: #0000ff;">var</span><span style="color: #000000;"> Action: TCloseAction);
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 4</span>   <span style="color: #008000;">//</span><span style="color: #008000;">窗口关闭时，从内存中移除窗口</span>
<span style="color: #008080;"> 5</span>   Action :=<span style="color: #000000;"> caFree;
</span><span style="color: #008080;"> 6</span>   FrmMDIChildTest := <span style="color: #0000ff;">nil</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmMDIChildTest.FormCreate(Sender: TObject);
</span><span style="color: #008080;">10</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">11</span>   <span style="color: #008000;">//</span><span style="color: #008000;">窗口创建时，在窗口菜单中加入窗口的菜单</span>
<span style="color: #008080;">12</span> <span style="color: #000000;">  MainFrm.dxBarListWindows.Items.AddObject(Caption, Self);
</span><span style="color: #008080;">13</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmMDIChildTest.FormDestroy(Sender: TObject);
</span><span style="color: #008080;">16</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">17</span>    <span style="color: #008000;">//</span><span style="color: #008000;">窗口关闭时，在窗口菜单中移除窗口的菜单</span>
<span style="color: #008080;">18</span>   <span style="color: #0000ff;">with</span> MainFrm.dxBarListWindows.Items <span style="color: #0000ff;">do</span>
<span style="color: #008080;">19</span> <span style="color: #000000;">    Delete(IndexOfObject(Self));
</span><span style="color: #008080;">20</span> <span style="color: #0000ff;">end</span>;</pre>
</div>
<p>&nbsp;　　<span style="color: #000000;">主界面<span style="text-decoration: underline; background-color: #99cc00;">窗口列表</span>菜单下（name：<span style="font-family: 微软雅黑; font-size: small;">dxBarListWindows</span>），需要再增加如下事件用来激活窗体列表：</span></p>
<p style="text-align: center; margin-left: 30px;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现30.png" alt="" /><br /></span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TMainFrm.dxBarListWindowsClick(Sender: TObject);
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 3</span>    <span style="color: #0000ff;">with</span> dxBarListWindows <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 4</span> <span style="color: #000000;">        TCustomForm(Items.Objects[ItemIndex]).Show;
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TMainFrm.dxBarListWindowsGetData(Sender: TObject);
</span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 9</span>    <span style="color: #0000ff;">with</span> dxBarListWindows <span style="color: #0000ff;">do</span>
<span style="color: #008080;">10</span>         ItemIndex :=<span style="color: #000000;"> Items.IndexOfObject(ActiveMDIChild);
</span><span style="color: #008080;">11</span> <span style="color: #0000ff;">end</span>;</pre>
</div>
<p>&nbsp;　　好的，我们再<span style="color: #000000;">看下效果，可以完成窗体列表中相关菜单的添加、激活和销毁：</span></p>
<p style="text-align: center; margin-left: 30px;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现31.png" alt="" /></span></p>
<hr />
<p style="text-align: left;"><strong><span style="font-size: 16px;">&nbsp;<span style="color: #008080;">RzCheckTree方式设计常见用户权限</span></span></strong></p>
<p style="margin-left: 30px;"><span style="color: #000000;">这里主要用到checkTree和数据的增删改查。</span></p>
<p style="margin-left: 30px;"><span style="color: #000112;">源码如下：</span>&nbsp;</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('2137018a-7dbf-42df-898f-cc15e40deec1')"><img id="code_img_closed_2137018a-7dbf-42df-898f-cc15e40deec1" class="code_img_closed" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现23.png" alt="" /><img id="code_img_opened_2137018a-7dbf-42df-898f-cc15e40deec1" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('2137018a-7dbf-42df-898f-cc15e40deec1',event)" src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现24.png" alt="" />
<div id="cnblogs_code_open_2137018a-7dbf-42df-898f-cc15e40deec1" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">unit</span><span style="color: #000000;"> uUserSet;
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> <span style="color: #0000ff;">interface</span>
<span style="color: #008080;">  4</span> 
<span style="color: #008080;">  5</span> <span style="color: #0000ff;">uses</span>
<span style="color: #008080;">  6</span> <span style="color: #000000;">  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
</span><span style="color: #008080;">  7</span> <span style="color: #000000;">  Dialogs, sCalculator, cxStyles, cxCustomData, cxGraphics, cxFilter,
</span><span style="color: #008080;">  8</span> <span style="color: #000000;">  cxData, cxDataStorage, cxEdit, DB, cxDBData, cxTextEdit, cxDropDownEdit,
</span><span style="color: #008080;">  9</span> <span style="color: #000000;">  ADODB, Ora, ComCtrls, RzTreeVw, StdCtrls, RzCmboBx, RzLabel, cxGridLevel,
</span><span style="color: #008080;"> 10</span> <span style="color: #000000;">  cxGridCustomTableView, cxGridTableView, cxGridDBTableView, cxClasses,
</span><span style="color: #008080;"> 11</span> <span style="color: #000000;">  cxControls, cxGridCustomView, cxGrid, Mask, RzEdit, RzRadChk, RzButton,
</span><span style="color: #008080;"> 12</span> <span style="color: #000000;">  ExtCtrls, RzPanel, RzTabs, cxCalendar, cxCheckBox, dxBar;
</span><span style="color: #008080;"> 13</span> 
<span style="color: #008080;"> 14</span> <span style="color: #0000ff;">type</span>
<span style="color: #008080;"> 15</span>   TFrmUserSet = <span style="color: #0000ff;">class</span><span style="color: #000000;">(TForm)
</span><span style="color: #008080;"> 16</span> <span style="color: #000000;">    pageControlMain: TRzPageControl;
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">    tabSheetUserSet: TRzTabSheet;
</span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    groupBoxParams: TRzGroupBox;
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">    btnRefresh: TRzBitBtn;
</span><span style="color: #008080;"> 20</span> <span style="color: #000000;">    btnAdd: TRzBitBtn;
</span><span style="color: #008080;"> 21</span> <span style="color: #000000;">    btnSave: TRzBitBtn;
</span><span style="color: #008080;"> 22</span> <span style="color: #000000;">    btnDelete: TRzBitBtn;
</span><span style="color: #008080;"> 23</span> <span style="color: #000000;">    checkBoxUserName: TRzCheckBox;
</span><span style="color: #008080;"> 24</span> <span style="color: #000000;">    edtUserName: TRzEdit;
</span><span style="color: #008080;"> 25</span> <span style="color: #000000;">    btnDodify: TRzBitBtn;
</span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    cxGridMain: TcxGrid;
</span><span style="color: #008080;"> 27</span> <span style="color: #000000;">    cxGridMainDBTableView1: TcxGridDBTableView;
</span><span style="color: #008080;"> 28</span> <span style="color: #000000;">    cxGridMainLevel1: TcxGridLevel;
</span><span style="color: #008080;"> 29</span> <span style="color: #000000;">    tabSheetAuthSet: TRzTabSheet;
</span><span style="color: #008080;"> 30</span> <span style="color: #000000;">    groupBoxParamsA: TRzGroupBox;
</span><span style="color: #008080;"> 31</span> <span style="color: #000000;">    labGroupName: TRzLabel;
</span><span style="color: #008080;"> 32</span> <span style="color: #000000;">    lblNewGroupName: TRzLabel;
</span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    cbbGroupName: TRzComboBox;
</span><span style="color: #008080;"> 34</span> <span style="color: #000000;">    btnSaveA: TRzBitBtn;
</span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    btnDeleteA: TRzBitBtn;
</span><span style="color: #008080;"> 36</span> <span style="color: #000000;">    edtNewGroupName: TRzEdit;
</span><span style="color: #008080;"> 37</span> <span style="color: #000000;">    btnAddA: TRzBitBtn;
</span><span style="color: #008080;"> 38</span> <span style="color: #000000;">    checkTreeMain: TRzCheckTree;
</span><span style="color: #008080;"> 39</span> <span style="color: #000000;">    qryTmp: TADOQuery;
</span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    qryUser: TADOQuery;
</span><span style="color: #008080;"> 41</span> <span style="color: #000000;">    dsUser: TDataSource;
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;">    qryUserAuthority: TADOQuery;
</span><span style="color: #008080;"> 43</span> <span style="color: #000000;">    cxGridMainDBTableView1Column1: TcxGridDBColumn;
</span><span style="color: #008080;"> 44</span> <span style="color: #000000;">    cxGridMainDBTableView1Column2: TcxGridDBColumn;
</span><span style="color: #008080;"> 45</span> <span style="color: #000000;">    cxGridMainDBTableView1Column3: TcxGridDBColumn;
</span><span style="color: #008080;"> 46</span> <span style="color: #000000;">    cxGridMainDBTableView1Column4: TcxGridDBColumn;
</span><span style="color: #008080;"> 47</span> <span style="color: #000000;">    cxGridMainDBTableView1Column5: TcxGridDBColumn;
</span><span style="color: #008080;"> 48</span> <span style="color: #000000;">    cxGridMainDBTableView1Column6: TcxGridDBColumn;
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    cxGridMainDBTableView1Column7: TcxGridDBColumn;
</span><span style="color: #008080;"> 50</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnRefreshClick(Sender: TObject);
</span><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">procedure</span> FormClose(Sender: TObject; <span style="color: #0000ff;">var</span><span style="color: #000000;"> Action: TCloseAction);
</span><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> FormDestroy(Sender: TObject);
</span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> FormCreate(Sender: TObject);
</span><span style="color: #008080;"> 54</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnAddClick(Sender: TObject);
</span><span style="color: #008080;"> 55</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnSaveClick(Sender: TObject);
</span><span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnDeleteClick(Sender: TObject);
</span><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnDodifyClick(Sender: TObject);
</span><span style="color: #008080;"> 58</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> LoadMenu(dxBar: TdxBarManager);
</span><span style="color: #008080;"> 59</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> cbbGroupNameClick(Sender: TObject);
</span><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnSaveAClick(Sender: TObject);
</span><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnDeleteAClick(Sender: TObject);
</span><span style="color: #008080;"> 62</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> btnAddAClick(Sender: TObject);
</span><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> qryUserBeforePost(DataSet: TDataSet);
</span><span style="color: #008080;"> 64</span>   <span style="color: #0000ff;">private</span>
<span style="color: #008080;"> 65</span>     <span style="color: #008000;">{</span><span style="color: #008000;"> Private declarations </span><span style="color: #008000;">}</span>
<span style="color: #008080;"> 66</span>   <span style="color: #0000ff;">public</span>
<span style="color: #008080;"> 67</span>     <span style="color: #008000;">{</span><span style="color: #008000;"> Public declarations </span><span style="color: #008000;">}</span>
<span style="color: #008080;"> 68</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 69</span> 
<span style="color: #008080;"> 70</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;"> 71</span> <span style="color: #000000;">  FrmUserSet: TFrmUserSet;
</span><span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span> <span style="color: #0000ff;">implementation</span>
<span style="color: #008080;"> 74</span> <span style="color: #0000ff;">uses</span>
<span style="color: #008080;"> 75</span> <span style="color: #000000;">  uMain, sysPublic;
</span><span style="color: #008080;"> 76</span> <span style="color: #008000;">{</span><span style="color: #008000;">$R *.dfm</span><span style="color: #008000;">}</span>
<span style="color: #008080;"> 77</span> 
<span style="color: #008080;"> 78</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.LoadMenu(dxBar: TdxBarManager);
</span><span style="color: #008080;"> 79</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;"> 80</span> <span style="color: #000000;">  I, L: integer;
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">  Tnode: TTreenode;
</span><span style="color: #008080;"> 82</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 83</span>   <span style="color: #0000ff;">with</span> checkTreeMain.Items <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 84</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 85</span> <span style="color: #000000;">    Clear;
</span><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> dxBar.Categories.Count - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 87</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 88</span>       Tnode := AddChild(<span style="color: #0000ff;">nil</span><span style="color: #000000;">, GetPosName(dxBar.Categories.Strings[i]));
</span><span style="color: #008080;"> 89</span>       <span style="color: #0000ff;">for</span> l := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> dxBar.ItemCount - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">if</span> dxBar.Items[l] <span style="color: #0000ff;">is</span> TdxBarButton <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 91</span>           <span style="color: #0000ff;">if</span> dxBar.Items[l].Category = i <span style="color: #0000ff;">then</span>
<span style="color: #008080;"> 92</span>           <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 93</span> <span style="color: #000000;">            AddChild(Tnode, GetPosName(dxBar.Items[l].Caption));
</span><span style="color: #008080;"> 94</span>           <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 95</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 96</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 97</span>   <span style="color: #0000ff;">with</span> qryTmp <span style="color: #0000ff;">do</span>
<span style="color: #008080;"> 98</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;"> 99</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">100</span>     SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">select MenuName from sysUserAuthority where SystemName=''CMS'' and GroupName=:GroupName</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">101</span>     Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">GroupName</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> cbbGroupName.Text;
</span><span style="color: #008080;">102</span> <span style="color: #000000;">    Open;
</span><span style="color: #008080;">103</span>     <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> checkTreeMain.Items.Count - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;">104</span>       <span style="color: #0000ff;">if</span> checkTreeMain.Items[i].Level &gt; <span style="color: #800080;">0</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">105</span>         <span style="color: #0000ff;">if</span> Locate(<span style="color: #800000;">'</span><span style="color: #800000;">MenuName</span><span style="color: #800000;">'</span>, checkTreeMain.Items[i].Text, []) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">106</span>           checkTreeMain.ItemState[i] :=<span style="color: #000000;"> csChecked;
</span><span style="color: #008080;">107</span> <span style="color: #000000;">    Close;
</span><span style="color: #008080;">108</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">109</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">110</span> 
<span style="color: #008080;">111</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnRefreshClick(Sender: TObject);
</span><span style="color: #008080;">112</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">113</span>   <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> checkBoxUserName.Checked <span style="color: #0000ff;">then</span>
<span style="color: #008080;">114</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">115</span>     <span style="color: #0000ff;">with</span> qryUser <span style="color: #0000ff;">do</span>
<span style="color: #008080;">116</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">117</span> <span style="color: #000000;">      Close;
</span><span style="color: #008080;">118</span> <span style="color: #000000;">      SQL.Clear;
</span><span style="color: #008080;">119</span>       SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">select * from sysUser t</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">120</span> <span style="color: #000000;">      Open;
</span><span style="color: #008080;">121</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">122</span>   <span style="color: #0000ff;">end</span>
<span style="color: #008080;">123</span>   <span style="color: #0000ff;">else</span>
<span style="color: #008080;">124</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">125</span>     <span style="color: #0000ff;">with</span> qryUser <span style="color: #0000ff;">do</span>
<span style="color: #008080;">126</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">127</span> <span style="color: #000000;">      Close;
</span><span style="color: #008080;">128</span> <span style="color: #000000;">      SQL.Clear;
</span><span style="color: #008080;">129</span>       SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">select * from sysUser t where t.UserName =''</span><span style="color: #800000;">'</span> + edtUserName.text + <span style="color: #800000;">'</span><span style="color: #800000;">''  or t.WorkNO =''</span><span style="color: #800000;">'</span> + edtUserName.text + <span style="color: #800000;">'</span><span style="color: #800000;">''</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">130</span> <span style="color: #000000;">      Open;
</span><span style="color: #008080;">131</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">132</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">133</span>   btnDodify.Enabled :=<span style="color: #000000;"> True;
</span><span style="color: #008080;">134</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">135</span> 
<span style="color: #008080;">136</span> <span style="color: #0000ff;">procedure</span> TFrmUserSet.FormClose(Sender: TObject; <span style="color: #0000ff;">var</span><span style="color: #000000;"> Action: TCloseAction);
</span><span style="color: #008080;">137</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">138</span>     <span style="color: #008000;">//</span><span style="color: #008000;">窗口关闭时，从内存中移除窗口</span>
<span style="color: #008080;">139</span>   Action :=<span style="color: #000000;"> caFree;
</span><span style="color: #008080;">140</span>   FrmUserSet := <span style="color: #0000ff;">nil</span><span style="color: #000000;">;
</span><span style="color: #008080;">141</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">142</span> 
<span style="color: #008080;">143</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.FormDestroy(Sender: TObject);
</span><span style="color: #008080;">144</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">145</span>   <span style="color: #008000;">//</span><span style="color: #008000;">窗口关闭时，在窗口菜单中移除窗口的菜单</span>
<span style="color: #008080;">146</span>   <span style="color: #0000ff;">with</span> MainFrm.dxBarListWindows.Items <span style="color: #0000ff;">do</span>
<span style="color: #008080;">147</span> <span style="color: #000000;">    Delete(IndexOfObject(Self));
</span><span style="color: #008080;">148</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">149</span> 
<span style="color: #008080;">150</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.FormCreate(Sender: TObject);
</span><span style="color: #008080;">151</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">152</span>     <span style="color: #008000;">//</span><span style="color: #008000;">窗口创建时，在窗口菜单中加入窗口的菜单</span>
<span style="color: #008080;">153</span> <span style="color: #000000;">  MainFrm.dxBarListWindows.Items.AddObject(Caption, Self);
</span><span style="color: #008080;">154</span> <span style="color: #000000;">  cbbGroupName.Items.Clear;
</span><span style="color: #008080;">155</span>   ComboAdd(cbbGroupName.Items, <span style="color: #800000;">'</span><span style="color: #800000;">select distinct GroupName from sysUserAuthority where SystemName=''CMS'' order by GroupName</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">156</span>   TcxComboBoxProperties(cxGridMainDBTableView1Column4.Properties).Items.Text :=<span style="color: #000000;"> cbbGroupName.Items.Text;
</span><span style="color: #008080;">157</span>   cbbGroupName.ItemIndex := <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">158</span> <span style="color: #000000;">  cbbGroupName.OnClick(Self);
</span><span style="color: #008080;">159</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">160</span> 
<span style="color: #008080;">161</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnAddClick(Sender: TObject);
</span><span style="color: #008080;">162</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">163</span> <span style="color: #000000;">  qryUser.Append;
</span><span style="color: #008080;">164</span>   btnSave.Enabled :=<span style="color: #000000;"> True;
</span><span style="color: #008080;">165</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">166</span> 
<span style="color: #008080;">167</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnSaveClick(Sender: TObject);
</span><span style="color: #008080;">168</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">169</span> <span style="color: #000000;">  qryUser.Post;
</span><span style="color: #008080;">170</span>   btnSave.Enabled :=<span style="color: #000000;"> False;
</span><span style="color: #008080;">171</span>   MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">保存成功,请不要重复操作！</span><span style="color: #800000;">'</span>, mtInformation, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">172</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">173</span> 
<span style="color: #008080;">174</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnDeleteClick(Sender: TObject);
</span><span style="color: #008080;">175</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">176</span>   <span style="color: #0000ff;">case</span> MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">删除将无法恢复，您确认要继续删除吗？</span><span style="color: #800000;">'</span><span style="color: #000000;">, mtWarning, [mbYes,
</span><span style="color: #008080;">177</span>     mbNo], <span style="color: #800080;">0</span>) <span style="color: #0000ff;">of</span>
<span style="color: #008080;">178</span> <span style="color: #000000;">    mrYes:
</span><span style="color: #008080;">179</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">180</span> <span style="color: #000000;">        qryUser.Delete;
</span><span style="color: #008080;">181</span>         btnSave.Enabled :=<span style="color: #000000;"> False;
</span><span style="color: #008080;">182</span>         MessageDlg(<span style="color: #800000;">'</span><span style="color: #800000;">删除成功,请不要重复操作！</span><span style="color: #800000;">'</span>, mtInformation, [mbOK], <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">183</span>       <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">184</span> <span style="color: #000000;">    mrNo:
</span><span style="color: #008080;">185</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">186</span> <span style="color: #000000;">        Exit;
</span><span style="color: #008080;">187</span>       <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">188</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">189</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">190</span> 
<span style="color: #008080;">191</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnDodifyClick(Sender: TObject);
</span><span style="color: #008080;">192</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">193</span>   btnSave.Enabled :=<span style="color: #000000;"> True;
</span><span style="color: #008080;">194</span>   btnDelete.Enabled :=<span style="color: #000000;"> True;
</span><span style="color: #008080;">195</span> <span style="color: #000000;">  qryUser.Edit;
</span><span style="color: #008080;">196</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">197</span> 
<span style="color: #008080;">198</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.cbbGroupNameClick(Sender: TObject);
</span><span style="color: #008080;">199</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">200</span> <span style="color: #000000;">  LoadMenu(MainFrm.dxBarManagerMain);
</span><span style="color: #008080;">201</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">202</span> 
<span style="color: #008080;">203</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnSaveAClick(Sender: TObject);
</span><span style="color: #008080;">204</span> <span style="color: #0000ff;">var</span>
<span style="color: #008080;">205</span> <span style="color: #000000;">  I: Integer;
</span><span style="color: #008080;">206</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">207</span>   <span style="color: #0000ff;">for</span> i := <span style="color: #800080;">0</span> <span style="color: #0000ff;">to</span> checkTreeMain.Items.Count - <span style="color: #800080;">1</span> <span style="color: #0000ff;">do</span>
<span style="color: #008080;">208</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">209</span>     <span style="color: #0000ff;">if</span> checkTreeMain.Items[i].Level &gt; <span style="color: #800080;">0</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">210</span>       <span style="color: #0000ff;">if</span> checkTreeMain.ItemState[i] = csChecked <span style="color: #0000ff;">then</span>
<span style="color: #008080;">211</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">212</span>         <span style="color: #0000ff;">with</span> qryTmp <span style="color: #0000ff;">do</span>
<span style="color: #008080;">213</span>         <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">214</span> <span style="color: #000000;">          Close;
</span><span style="color: #008080;">215</span> <span style="color: #000000;">          SQL.Clear;
</span><span style="color: #008080;">216</span>           SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">SELECT * FROM sysUserAuthority WHERE GROUPNAME =:GROUPNAME AND MENUNAME =:MENUNAME</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">217</span>           Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">GROUPNAME</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> cbbGroupName.Text;
</span><span style="color: #008080;">218</span>           Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">MENUNAME</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> checkTreeMain.Items.Item[i].Text;
</span><span style="color: #008080;">219</span> <span style="color: #000000;">          Open;
</span><span style="color: #008080;">220</span>           <span style="color: #0000ff;">if</span> RecordCount = <span style="color: #800080;">0</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">221</span>           <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">222</span> <span style="color: #000000;">            qryUserAuthority.Close;
</span><span style="color: #008080;">223</span> <span style="color: #000000;">            qryUserAuthority.SQL.Clear;
</span><span style="color: #008080;">224</span>             qryUserAuthority.SQL.Text := <span style="color: #800000;">'</span><span style="color: #800000;">INSERT INTO sysUserAuthority(GROUPNAME, MENUNAME, SystemName) VALUES(:GROUPNAME, :MENUNAME, :SystemName)</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">225</span>             qryUserAuthority.Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">GROUPNAME</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> cbbGroupName.Text;
</span><span style="color: #008080;">226</span>             qryUserAuthority.Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">MENUNAME</span><span style="color: #800000;">'</span>).Value :=<span style="color: #000000;"> checkTreeMain.Items.Item[i].Text;
</span><span style="color: #008080;">227</span>             qryUserAuthority.Parameters.ParamByName(<span style="color: #800000;">'</span><span style="color: #800000;">SystemName</span><span style="color: #800000;">'</span>).Value := <span style="color: #800000;">'</span><span style="color: #800000;">CMS</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">228</span> <span style="color: #000000;">            qryUserAuthority.ExecSQL;
</span><span style="color: #008080;">229</span>           <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">230</span>         <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">231</span>       <span style="color: #0000ff;">end</span>
<span style="color: #008080;">232</span>       <span style="color: #0000ff;">else</span>
<span style="color: #008080;">233</span>       <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">234</span>         ExecSql(<span style="color: #800000;">'</span><span style="color: #800000;">DELETE FROM sysUserAuthority WHERE SystemName= ''CMS'' AND GROUPNAME=''</span><span style="color: #800000;">'</span> + cbbGroupName.Text + <span style="color: #800000;">'</span><span style="color: #800000;">'' AND MENUNAME=''</span><span style="color: #800000;">'</span> + checkTreeMain.Items.Item[i].Text + <span style="color: #800000;">'</span><span style="color: #800000;">''</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">235</span>       <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">236</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">237</span>   TcxComboBoxProperties(cxGridMainDBTableView1Column4.Properties).Items.Text :=<span style="color: #000000;"> cbbGroupName.Items.Text;
</span><span style="color: #008080;">238</span>   ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">保存成功！</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">239</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">240</span> 
<span style="color: #008080;">241</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnDeleteAClick(Sender: TObject);
</span><span style="color: #008080;">242</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">243</span>   <span style="color: #0000ff;">if</span> MessageDLG(<span style="color: #800000;">'</span><span style="color: #800000;">您确定要删除该分组权限吗？</span><span style="color: #800000;">'</span>, mtconfirmation, [MBOK, MBCANCEL], <span style="color: #800080;">0</span>) = MRCANCEL <span style="color: #0000ff;">then</span><span style="color: #000000;"> exit;
</span><span style="color: #008080;">244</span>   ExecSql(<span style="color: #800000;">'</span><span style="color: #800000;">Delete from sysUserAuthority where SystemName=''</span><span style="color: #800000;">'</span> + Application.Title + <span style="color: #800000;">'</span><span style="color: #800000;">'' AND groupname=''</span><span style="color: #800000;">'</span> + cbbGroupName.Text + <span style="color: #800000;">'</span><span style="color: #800000;">''</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">245</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">246</span> 
<span style="color: #008080;">247</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.btnAddAClick(Sender: TObject);
</span><span style="color: #008080;">248</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">249</span>   <span style="color: #0000ff;">if</span> edtNewGroupName.Text = <span style="color: #800000;">''</span> <span style="color: #0000ff;">then</span>
<span style="color: #008080;">250</span>   <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">251</span>     ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">请先输入组名!</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">252</span> <span style="color: #000000;">    exit;
</span><span style="color: #008080;">253</span>   <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">254</span> <span style="color: #000000;">  cbbGroupName.Items.Add(edtNewGroupName.Text);
</span><span style="color: #008080;">255</span>   cbbGroupName.ItemIndex := cbbGroupName.Items.Count - <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">256</span> <span style="color: #000000;">  cbbGroupName.OnClick(self);
</span><span style="color: #008080;">257</span>   ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">添加成功！</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">258</span>   edtNewGroupName.Text := <span style="color: #800000;">''</span><span style="color: #000000;">;
</span><span style="color: #008080;">259</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">260</span> 
<span style="color: #008080;">261</span> <span style="color: #0000ff;">procedure</span><span style="color: #000000;"> TFrmUserSet.qryUserBeforePost(DataSet: TDataSet);
</span><span style="color: #008080;">262</span> <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">263</span>     <span style="color: #0000ff;">if</span> (Pos(<span style="color: #800000;">'</span> <span style="color: #800000;">'</span>, qryUser.FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">UserName</span><span style="color: #800000;">'</span>).AsString) &gt; <span style="color: #800080;">0</span>) <span style="color: #0000ff;">or</span> (Pos(<span style="color: #800000;">'</span> <span style="color: #800000;">'</span>, qryUser.FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">PassCode</span><span style="color: #800000;">'</span>).AsString) &gt; <span style="color: #800080;">0</span>) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">264</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">265</span>         ShowMessage(<span style="color: #800000;">'</span><span style="color: #800000;">用户名或密码中不能有空格！请重新输入</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">266</span> <span style="color: #000000;">        Abort;
</span><span style="color: #008080;">267</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">268</span>     <span style="color: #0000ff;">if</span> (qryUser.State = dsInsert) <span style="color: #0000ff;">or</span> ((qryUser.State = dsEdit) <span style="color: #0000ff;">and</span> (Length(qryUser.FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">PassCode</span><span style="color: #800000;">'</span>).AsString) &lt; <span style="color: #800080;">20</span>)) <span style="color: #0000ff;">then</span>
<span style="color: #008080;">269</span>     <span style="color: #0000ff;">begin</span>
<span style="color: #008080;">270</span>         qryUser.FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">PassCode</span><span style="color: #800000;">'</span>).AsString := GetMd5Str(qryUser.FieldByName(<span style="color: #800000;">'</span><span style="color: #800000;">PassCode</span><span style="color: #800000;">'</span><span style="color: #000000;">).AsString);
</span><span style="color: #008080;">271</span>     <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">272</span> <span style="color: #0000ff;">end</span><span style="color: #000000;">;
</span><span style="color: #008080;">273</span> 
<span style="color: #008080;">274</span> <span style="color: #0000ff;">end</span>.</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p style="text-align: left;"><span style="color: #008080;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现34.png" alt="" /></span></p>
<p><span style="color: #008080;">　　<span style="color: #000000;">OK，今天就到这里吧，其实整个通用的管理系统架构基本已经完成了，我们明天主要完善/美化一下界面。</span></span></p>
<p><span style="color: #008080;"><span style="color: #000000;">　　感觉写博客比做技术还累，专业的事情交给专业的人做(⊙﹏⊙)。。。。。。</span></span></p>
<p><span style="color: #008080;"><span style="color: #000000;">　　<span style="font-family: 楷体; font-size: 16px; background-color: #33cccc;">能看到这里的绝逼是Delphi真爱。。。。。</span></span></span></p>
<p style="text-align: center;"><span style="color: #008080;"><span style="color: #000000;">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现35.png" alt="" /><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现36.png" alt="" /></span></span>&nbsp;</p>
<h3>&nbsp;</h3>
<hr />
<h3><span style="color: #008080;">imageList图标库</span></h3>
<p><span style="color: #000000;">　　小伙伴，今天我们继续打卡。</span></p>
<p style="text-align: center;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现37.png" alt="" /></span></p>
<p><span style="color: #000000;">　　imageList图标仓库，主要用于菜单的美化。</span></p>
<p><span style="color: #000000;">　　</span><span style="color: #000000;">在主界面拖一个imageList控件<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现38.png" alt="" /></span><span style="color: #000000;">，命名为imageListMain，然后添加一些图标进去。如下图。</span></p>
<p style="text-align: center;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现39.png" alt="" /></span></p>
<p style="text-align: left;">　　然后，完成dxBarManagerMain和imageListMain的绑定（dxBarManagerMain的image属性）。</p>
<p style="text-align: left;">　　OK，至此，就可以为主菜单增加图标了（选中菜单，根据需要选择imageIndex）。</p>
<p style="text-align: center;">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现40.png" alt="" /><span style="color: #000000;"><br /></span></p>
<h3><span style="color: #000112;"><span style="color: #008080;"><strong>第三方控件：RC、AlphaControl皮肤控件</strong></span></span></h3>
<p><span style="color: #000000;">　　后来我想了一下，关于第三方库，就不再讲解了，大家有兴趣可以自行研究。说句傲娇的话，做技术最重要的是功能，花里胡哨的干啥呀！</span><span style="color: #000112;"><br /></span></p>
<p style="text-align: center;"><span style="color: #000000;">　　<img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现41.png" alt="" /><br /></span></p>
<p><span style="color: #000000;">　　不过话说回来，好的UI界面能够极大的提高用户体验（啪啪打脸(⊙﹏⊙)），下面带大家看下AlphaControl皮肤控件的Demo效果（到这里下载控件包<a href="http://www.alphaskins.com/showdoc.php?l=en&amp;n=5" target="_blank">AlphaControl官网</a>）。</span></p>
<p style="text-align: center;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现42.png" alt="" /></span></p>
<h2><span style="color: #008080;">最后</span></h2>
<p><span style="color: #000000;">　　最后，作为一名程序员，语言只是一种工具，如何快速、高效的达到项目需求，才是最主要的。</span></p>
<p><span style="color: #000000;">　　最最重要的是：我们要时刻保持对技术的热爱，兴趣是最好的老师，活到老学到老！</span></p>
<p><span style="color: #000000;">　　OK，最后看下我们这个项目的总体效果！</span></p>
<p style="text-align: center;"><span style="color: #000000;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现43.png" alt="" />　　</span></p>
<hr />
<h2 style="text-align: center;"><strong><span style="color: #000018;"><img src="./images/Delphi - 手把手教你基于D7+Access常用管理系统架构的设计与实现44.png" alt="" /></span></strong>&nbsp;</h2>
<p><span style="font-family: 楷体; font-size: 16px; background-color: #33cccc;">任何疑问、建议、意见请留言或者私信我哦~~~~</span></p>
<p><span style="font-family: 楷体; font-size: 16px; background-color: #33cccc;">源码已上传GitHub，</span><span style="font-family: 楷体; font-size: 16px; background-color: #33cccc;">点击下载<a href="https://github.com/JeremyWu917/CommonManagementSystem" target="_blank"><span style="text-decoration: underline; background-color: #33cccc;">源码</span></a>，有任何疑问欢迎和我交流。&nbsp;</span></p>
<div id="AllanboltSignature">
<p id="PSignature" style="padding-top: 10px; padding-right: 10px; padding-bottom: 10px; padding-left: 60px; background: url('https://images.cnblogs.com/cnblogs_com/jeremywucnblog/1607637/o_191206011825obs.png') #e5f1f4 no-repeat 1% 50%; font-family: 微软雅黑; font-size: 11px; border: #e0e0e0 1px dashed;">&nbsp; 作者：<a href="https://www.cnblogs.com/jeremywucnblog/" target="_blank">Jeremy.Wu</a> <br />&nbsp; 出处：<a href="https://www.cnblogs.com/jeremywucnblog/" target="_blank">https://www.cnblogs.com/jeremywucnblog/</a>
            <br />&nbsp; 本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。
        </p>




























</div>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>