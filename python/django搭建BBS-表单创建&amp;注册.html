<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修django搭建BBS-表单创建&amp;注册' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>django搭建BBS-表单创建&amp;注册</center></div><div class='banquan'>原文出处:本文由博客园博主小小咸鱼YwY提供。<br/>
原文连接:https://www.cnblogs.com/pythonywy/p/11405681.html</div><br>
    <h1 id="django搭建bbs-表单创建注册">django搭建BBS-表单创建&amp;注册</h1>
<h2 id="自我总结">0824自我总结</h2>
<h2 id="文件结构">文件结构</h2>
<ul>
<li>app 接口
<ul>
<li>migrations</li>
<li>__inint__.py</li>
<li>admin.py <code>管理员页面注册表单用</code></li>
<li>apps.py</li>
<li>bbsform.py <code>form组件相关设置</code></li>
<li>models.py <code>模型存放</code></li>
<li>tests.py</li>
<li>views.py <code>业务逻辑</code></li>
</ul></li>
<li>avatar <code>图片文件存储</code></li>
<li>BBS <code>项目名称以及路由存放</code>
<ul>
<li>__inint__.py</li>
<li>settings.py</li>
<li>urls.py</li>
<li>wsgi.py</li>
</ul></li>
<li>static
<ul>
<li>bootstrap-3.3.7-dist <code>bootstrap文件网上下载的</code></li>
<li>jquery-3.4.1.min.js <code>jq文件</code></li>
</ul></li>
<li>templates <code>页面文件存放</code></li>
</ul>
<h2 id="一.django相关设置">一.django相关设置</h2>
<p><code>settings.py</code></p>
<pre><code><code>&quot;&quot;&quot;
Django settings for BBS project.

Generated by &#39;django-admin startproject&#39; using Django 1.11.22.

For more information on this file, see
https://docs.djangoproject.com/en/1.11/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/1.11/ref/settings/
&quot;&quot;&quot;

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/1.11/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = &#39;s0x+v@gqeoxs4ruj58cq5&amp;*5#7on_h$n4-$hwb3cr&amp;h(@qcmoc&#39;

# SECURITY WARNING: don&#39;t run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;app.apps.AppConfig&#39;,
]

MIDDLEWARE = [
    &#39;django.middleware.security.SecurityMiddleware&#39;,
    &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,
    &#39;django.middleware.common.CommonMiddleware&#39;,
    &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,
    &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,
    &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,
    &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,
]

ROOT_URLCONF = &#39;BBS.urls&#39;

TEMPLATES = [
    {
        &#39;BACKEND&#39;: &#39;django.template.backends.django.DjangoTemplates&#39;,
        &#39;DIRS&#39;: [os.path.join(BASE_DIR, &#39;templates&#39;)]
        ,
        &#39;APP_DIRS&#39;: True,
        &#39;OPTIONS&#39;: {
            &#39;context_processors&#39;: [
                &#39;django.template.context_processors.debug&#39;,
                &#39;django.template.context_processors.request&#39;,
                &#39;django.contrib.auth.context_processors.auth&#39;,
                &#39;django.contrib.messages.context_processors.messages&#39;,
            ],
        },
    },
]

WSGI_APPLICATION = &#39;BBS.wsgi.application&#39;


# Database
# https://docs.djangoproject.com/en/1.11/ref/settings/#databases

DATABASES = {
    &#39;default&#39;: {
        &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,
        &#39;NAME&#39;: os.path.join(BASE_DIR, &#39;db.sqlite3&#39;),
    }
}


# Password validation
# https://docs.djangoproject.com/en/1.11/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.MinimumLengthValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.CommonPasswordValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.NumericPasswordValidator&#39;,
    },
]


# Internationalization
# https://docs.djangoproject.com/en/1.11/topics/i18n/

LANGUAGE_CODE = &#39;en-us&#39;

TIME_ZONE = &#39;UTC&#39;

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.11/howto/static-files/

STATIC_URL = &#39;/static/&#39;
STATICFILES_DIRS=(
    os.path.join(BASE_DIR,&#39;static&#39;),
)

#因为我创建模型的时候用到了user的类
AUTH_USER_MODEL=&#39;app.Userinfo&#39;</code></pre>
<h2 id="二.模型的创建管理页面注册">二.模型的创建&amp;管理页面注册</h2>
<p>models.py</p>
<pre><code><code>from django.db import models
from django.contrib.auth.models import AbstractUser


class UserInfo(AbstractUser):
    nid = models.AutoField(primary_key=True)
    # 头像：FileField文件（varchar类型），default：默认值，upload_to上传的路径
    avatar = models.FileField(upload_to=&#39;avatar/&#39;, default=&#39;avatar/default.png&#39;)
    #跟blog表一对一
    #OneToOneField本质就是ForeignKey，只不过有个唯一性约束
    blog = models.OneToOneField(to=&#39;Blog&#39;, to_field=&#39;nid&#39;,null=True)
    # blog = models.ForeignKey(to=&#39;Blog&#39;, to_field=&#39;nid&#39;,null=True,unique=True)

    class Meta:
        # db_table=&#39;xxxx&#39;
        # 在admin中显示的表名
        verbose_name=&#39;用户表&#39;
        #去掉  用户表  后的s
        verbose_name_plural = verbose_name

class Blog(models.Model):
    nid = models.AutoField(primary_key=True)
    #站点名称
    title = models.CharField(max_length=64)
    #站点副标题
    site_name = models.CharField(max_length=32)
    #不同人不同主题
    theme = models.CharField(max_length=64)
    def __str__(self):
        return self.site_name
#分类表
class Category(models.Model):
    nid = models.AutoField(primary_key=True)
    #分类名称
    title = models.CharField(max_length=64)
    #跟博客是一对多的关系，关联字段写在多的一方
    #to  是跟哪个表关联   to_field跟表中的哪个字段做关联， null=True 表示可以为空
    blog = models.ForeignKey(to=&#39;Blog&#39;, to_field=&#39;nid&#39;, null=True)
    def __str__(self):
        return self.title

class Tag(models.Model):
    nid = models.AutoField(primary_key=True)
    #标签名字
    title = models.CharField(max_length=64)
    # 跟博客是一对多的关系，关联字段写在多的一方
    blog = models.ForeignKey(to=&#39;Blog&#39;, to_field=&#39;nid&#39;, null=True)
    def __str__(self):
        return self.title

class Article(models.Model):
    nid = models.AutoField(primary_key=True)
    #verbose_name在admin中显示该字段的中文
    title = models.CharField(max_length=64,verbose_name=&#39;文章标题&#39;)
    #文章摘要
    desc = models.CharField(max_length=255)
    #文章内容  大文本
    content = models.TextField()
    #DateTimeField 年月日时分秒（注意跟datafield的区别）
    #auto_now_add=True:插入数据会存入当前时间
    #auto_now=True  修改数据会存入当前时间
    create_time = models.DateTimeField(auto_now_add=True)
    commit_num=models.IntegerField(default=0)
    up_num=models.IntegerField(default=0)
    down_num=models.IntegerField(default=0)
#一对多的关系
    blog = models.ForeignKey(to=&#39;Blog&#39;, to_field=&#39;nid&#39;, null=True)
    # 一对多的关系
    category = models.ForeignKey(to=&#39;Category&#39;, to_field=&#39;nid&#39;, null=True)
    #多对多关系  through_fields  不能写反了：
    tag = models.ManyToManyField(to=&#39;Tag&#39;, through=&#39;ArticleTOTag&#39;, through_fields=(&#39;article&#39;, &#39;tag&#39;))
    def __str__(self):
        return self.title+&#39;----&#39;+self.blog.userinfo.username

class ArticleTOTag(models.Model):
    nid = models.AutoField(primary_key=True)
    article = models.ForeignKey(to=&#39;Article&#39;, to_field=&#39;nid&#39;)
    tag = models.ForeignKey(to=&#39;Tag&#39;, to_field=&#39;nid&#39;)

class Commit(models.Model):
    #谁对那篇文章评论了什么内容
    nid = models.AutoField(primary_key=True)
    user = models.ForeignKey(to=&#39;UserInfo&#39;, to_field=&#39;nid&#39;)
    article = models.ForeignKey(to=&#39;Article&#39;, to_field=&#39;nid&#39;)
    content = models.CharField(max_length=255)
    #评论时间
    create_time = models.DateTimeField(auto_now_add=True)
    #自关联（）
    parent = models.ForeignKey(to=&#39;self&#39;, to_field=&#39;nid&#39;,null=True,blank=True)

class UpAndDown(models.Model):
    #谁对那篇文章点赞或点踩
    nid = models.AutoField(primary_key=True)
    user = models.ForeignKey(to=&#39;UserInfo&#39;, to_field=&#39;nid&#39;)
    article = models.ForeignKey(to=&#39;Article&#39;, to_field=&#39;nid&#39;)
    #布尔类型，本质也还是0和1
    is_up = models.BooleanField()

    class Meta:
        #联合唯一，一个用户只能给一片文章点赞或点踩
        unique_together = ((&#39;user&#39;, &#39;article&#39;),)</code></pre>
<p>admin.py</p>
<pre><code><code>from django.contrib import admin

# Register your models here.
#先导入模型
from app import models

#注册表
admin.site.register(models.UserInfo)
admin.site.register(models.Blog)
admin.site.register(models.Category)
admin.site.register(models.Tag)
admin.site.register(models.Article)
admin.site.register(models.ArticleTOTag)
admin.site.register(models.Commit)
admin.site.register(models.UpAndDown)
</code></pre>
<h2 id="三.路由">三.路由</h2>
<p>urls.py</p>
<pre><code><code>from django.conf.urls import url
from django.contrib import admin
#主路由导入视图内函数
from app import views
urlpatterns = [
    url(r&#39;^admin/&#39;, admin.site.urls),
    url(r&#39;^register/&#39;, views.register),
]</code></pre>
<h2 id="四.form组件">四.form组件</h2>
<pre><code><code>
from django import forms
from django.forms import widgets

from django.core.exceptions import ValidationError

from app import models
#写一个类，继承Form  没有头像校验的字段
class Register(forms.Form):
    username=forms.CharField(max_length=18,min_length=3,label=&quot;用户名&quot;,
                         error_messages={&#39;max_length&#39;:&#39;太长了&#39;,
                                         &#39;min_length&#39;:&#39;太短了&#39;,
                                         &#39;required&#39;:&#39;不能为空&#39;},
                            widget=widgets.TextInput(attrs={&#39;class&#39;:&#39;form-control&#39;}),
                         )
    password=forms.CharField(max_length=18,min_length=3,label=&quot;密码&quot;,
                         error_messages={&#39;max_length&#39;:&#39;太长了&#39;,
                                         &#39;min_length&#39;:&#39;太短了&#39;,
                                         &#39;required&#39;:&#39;不能为空&#39;},
                            widget=widgets.PasswordInput(attrs={&#39;class&#39;:&#39;form-control&#39;}),
                         )
    re_pwd=forms.CharField(max_length=18,min_length=3,label=&quot;确认密码&quot;,
                         error_messages={&#39;max_length&#39;:&#39;太长了&#39;,
                                         &#39;min_length&#39;:&#39;太短了&#39;,
                                         &#39;required&#39;:&#39;不能为空&#39;},
                            widget=widgets.PasswordInput(attrs={&#39;class&#39;:&#39;form-control&#39;}),
                         )
    email=forms.EmailField(max_length=18,min_length=3,label=&quot;邮箱&quot;,
                         error_messages={&#39;max_length&#39;:&#39;太长了&#39;,
                                         &#39;min_length&#39;:&#39;太短了&#39;,
                                         &#39;required&#39;:&#39;不能为空&#39;},
                            widget=widgets.EmailInput(attrs={&#39;class&#39;:&#39;form-control&#39;}),
                         )
    #局部钩子，局部校验
    def clean_username(self):
        #取出name对应的值
        name=self.cleaned_data.get(&#39;username&#39;)
        # if name.startswith(&#39;sb&#39;):
        #     #校验不通过，抛异常
        #     raise ValidationError(&#39;不能以sb开头&#39;)
        #     #校验通过，直接return name值
        # else:
        #     return name
        user=models.UserInfo.objects.filter(username=name).first()
        if user:
            #用户存在，抛异常
            raise ValidationError(&#39;用户已经存在&#39;)
        else:
            return name
    #全局钩子，全局校验

    def clean(self):
        pwd=self.cleaned_data.get(&#39;password&#39;)
        r_pwd=self.cleaned_data.get(&#39;re_pwd&#39;)
        if pwd==r_pwd:
            #校验通过，返回清洗后的数据
            return self.cleaned_data
        else:
            #校验不通过，抛异常
            raise ValidationError(&#39;两次密码不一致&#39;)</code></pre>
<h2 id="五.业务逻辑html页面">五.业务逻辑&amp;html页面</h2>
<h2 id="业务逻辑">1.业务逻辑</h2>
<p>views.py</p>
<pre><code><code>from django.shortcuts import render,HttpResponse,redirect
from django.http import JsonResponse
#Image导入
#ImageDraw在图片上写字
#ImageFont 写字的格式
from PIL import Image,ImageDraw,ImageFont
import random
# 相当于把文件以byte格式存到内存中
from io import BytesIO

from django.contrib import auth

from app.bbsforms import Register
from app import models

from django.db.models import Count
from django.db.models.functions import TruncMonth
from django.db.models import F





# Create your views here.
def register(request):
    if request.method==&#39;GET&#39;:
        form=Register()
        return render(request,&#39;register.html&#39;,{&#39;form&#39;:form})
    elif request.is_ajax():
        response={&#39;code&#39;:100,&#39;msg&#39;:None}
        form = Register(request.POST)
        if form.is_valid():
            #校验通过的数据
            clean_data=form.cleaned_data
            #把re_pwd剔除
            clean_data.pop(&#39;re_pwd&#39;)
            #取出头像
            avatar=request.FILES.get(&#39;avatar&#39;)
            if avatar:
                #因为用的是FileField，只需要把文件对象赋值给avatar字段，自动做保存
                clean_data[&#39;avatar&#39;]=avatar
            user=models.UserInfo.objects.create_user(**clean_data)
            if user:
                response[&#39;msg&#39;] = &#39;创建成功&#39;
            else:
                response[&#39;code&#39;] = 103
                # 把校验不通过的数据返回
                response[&#39;msg&#39;] = &#39;创建失败&#39;
        else:
            response[&#39;code&#39;]=101
            #把校验不通过的数据返回
            response[&#39;msg&#39;]=form.errors
            print(type(form.errors))
        return JsonResponse(response,safe=False)</code></pre>
<h2 id="网页">2.网页</h2>
<h3 id="常见的几条函数的封装">常见的几条函数的封装</h3>
<p>jq.html</p>
<pre><code><code>&lt;script src=&quot;/static/jquery-3.4.1.min.js&quot;&gt;&lt;/script&gt;</code></pre>
<p>bootstrap.html</p>
<pre><code><code>&lt;link rel=&quot;stylesheet&quot; href=&#39;/static/bootstrap-3.3.7-dist/css/bootstrap.min.css&#39;&gt;
&lt;script src=&quot;/static/bootstrap-3.3.7-dist/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</code></pre>
<h3 id="主视图">主视图</h3>
<p>register.html</p>
<pre><code><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;注册&lt;/title&gt;
    {% include &#39;bootstrap.html&#39; %}
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container-fluid&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;col-md-6 col-md-offset-3&quot;&gt;

            &lt;h1&gt;注册&lt;/h1&gt;
            &lt;form id=&quot;my_form&quot;&gt;
                {% csrf_token %}
                {% for foo in form %}
                    &lt;div class=&quot;form-group&quot;&gt;
                        {#foo.auto_id   就是foo生成的input的id#}
                        &lt;label for=&quot;{{ foo.auto_id }}&quot;&gt;{{ foo.label }}&lt;/label&gt;
                        {{ foo }} &lt;span style=&quot;color: red&quot; class=&quot;error pull-right&quot;&gt;&lt;/span&gt;
                    &lt;/div&gt;

                {% endfor %}
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;id_file&quot;&gt;头像
                        &lt;img src=&quot;/static/img/default.png&quot; width=&quot;80&quot; height=&quot;80&quot; style=&quot;margin-left: 20px&quot; id=&quot;id_img&quot;&gt;
                    &lt;/label&gt;


                    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;id_file&quot; style=&quot;display: none&quot;&gt;
                &lt;/div&gt;
                &lt;input type=&quot;button&quot; class=&quot;btn btn-success&quot; value=&quot;提交&quot; id=&quot;id_submit&quot;&gt;
            &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
{% include &#39;jq.html&#39; %}
&lt;script&gt;
    //当该控件发生变化，响应该事件
    $(&quot;#id_file&quot;).change(function () {
        //alert(1)
        //取到文件对象
        var file = $(&quot;#id_file&quot;)[0].files[0]
        //放到img控件上，借助于filereader 中间的东西，文件阅读器
        //生成一个文件阅读器对象赋值给filereader
        var filereader = new FileReader()
        //把文件读到filereader对象中
        //读文件需要时间，需要文件读完再去操作img
        filereader.readAsDataURL(file)

        filereader.onload = function () {
            $(&quot;#id_img&quot;).attr(&#39;src&#39;, filereader.result)
        }

    })
    $(&quot;#id_submit&quot;).click(function () {

        //ajax 上传文件


        var formdata = new FormData()
        //一个一个往里添加，稍微复杂，用简便方法
        // formdata.append(&#39;name&#39;,$(&quot;#id_name&quot;).val())
        // formdata.append(&#39;pwd&#39;,$(&quot;#id_pwd&quot;).val())

        //简便方法
        //form 对象的serializeArray，它会把form中的数据包装到一个对象中（不包含文件）
        var my_form_data = $(&quot;#my_form&quot;).serializeArray()
        //console.log(typeof my_form_data)
        //console.log(my_form_data)
        //jq的循环，传两个参数，第一个是要循环的对象，第二个参数是一个匿名函数
        $.each(my_form_data, function (k, v) {
            {#console.log(k)#}
            {#console.log(v)#}
            formdata.append(v.name, v.value)
        })
        formdata.append(&#39;avatar&#39;, $(&quot;#id_file&quot;)[0].files[0])


        $.ajax({
            url: &#39;/register/&#39;,
            type: &#39;post&#39;,
            processData: false, //告诉jQuery不要去处理发送的数据
            contentType: false,// 告诉jQuery不要去设置Content-Type请求头
            data: formdata,
            success: function (data) {
                //console.log(data)
                if(data.code==100){
                    location.href=&#39;/login/&#39;
                }else if(data.code==101){
                    $.each(data.msg,function (k,v) {
                        console.log(k)
                        console.log(v)
                        $(&quot;#id_&quot;+k).next().html(v[0])
                        if(k==&#39;__all__&#39;){
                            $(&quot;#id_re_pwd&quot;).next().html(v[0])
                        }

                    })

                }
                //定时器
                setTimeout(function () {
                    $(&quot;.error&quot;).html(&quot;&quot;)
                },3000)
            }


        })
    })


&lt;/script&gt;
&lt;/html&gt;</code></pre>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>